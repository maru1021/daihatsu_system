{% load static %}
{% load dict_filters %}

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>åŠ å·¥å‡ºåº«æ•°èª¿æ•´ - {{ year }}å¹´{{ month }}æœˆ</title>
<link href="{% static 'css/vendor/bootstrap/bootstrap.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/select2/select2.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/select2/select2-bootstrap-5-theme.min.css' %}" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/production_plan.css' %}">
</head>
<body class="assembly-plan">
<div class="page-container">
    <div class="header-section">
        <div class="page-title">åŠ å·¥å‡ºåº«æ•°èª¿æ•´</div>
        <div class="controls-wrapper">
            <div class="left-controls">
                <div class="control-row">
                    <label for="line-type-select">åŠ å·¥ã‚¿ã‚¤ãƒ—ï¼š</label>
                    <select id="line-type-select" class="line-select select2">
                        {% for type in line_types %}
                        <option value="{{ type }}" {% if type == line_type %}selected{% endif %}>{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="control-row">
                    <label for="target-month">å¯¾è±¡æœˆï¼š</label>
                    <input type="month" id="target-month" class="month-input" value="{{ year }}-{{ month|stringformat:'02d' }}">
                </div>
            </div>

            <div class="monthly-plan-card">
                <div class="monthly-plan-title">ğŸ“Š çµ„ä»˜å‡ºåº«æ•°</div>
                <div class="monthly-plan-grid">
                    {% for item_name in item_names %}
                        <div class="monthly-plan-item" data-item-name="{{ item_name }}">
                            <div class="monthly-plan-item-name">{{ item_name }}</div>
                            <div class="monthly-plan-item-quantity">
                                <span class="assembly-total">0</span> å°
                                <span class="monthly-plan-diff"></span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="right-controls">
                <button type="button" id="save-btn" class="save-btn">ä¿å­˜</button>
                <button type="button" class="machining-schedule-btn" onclick="window.location.href='{% url 'management_room:machining_production_plan' %}?year={{ year }}&month={{ month }}'">åŠ å·¥ç”Ÿç”£è¨ˆç”»</button>
                <button type="button" id="main-btn" class="main-btn" onclick="window.location.href='/'">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸</button>
            </div>
        </div>
    </div>

<div class="table-container" id="schedule-table">
<table>
<thead>
<tr class="time-check-row">
<th colspan="3" rowspan="{{ assembly_lines_data|length|add:1 }}">å®Œæˆå“ç•ª</th>
<!-- æ—¥ä»˜ -->
{% for date_info in dates_data %}
<th{% if date_info.is_weekend %} class="weekend"{% endif %}>{{ month }}/{{ date_info.day }}<br/>({% if date_info.weekday == 0 %}æœˆ{% elif date_info.weekday == 1 %}ç«{% elif date_info.weekday == 2 %}æ°´{% elif date_info.weekday == 3 %}æœ¨{% elif date_info.weekday == 4 %}é‡‘{% elif date_info.weekday == 5 %}åœŸ{% elif date_info.weekday == 6 %}æ—¥{% endif %})</th>
{% endfor %}
<th rowspan="{{ assembly_lines_data|length|add:1 }}">æœˆè¨ˆ</th>
</tr>
{% for line_data in assembly_lines_data %}
<tr>
{% for date_info in dates_data %}
<th{% if date_info.is_weekend %} class="weekend"{% endif %}>{{ date_info.occupancy_rates|get_item:line_data.name|default:"-" }}%</th>
{% endfor %}
</tr>
{% endfor %}
</thead>
<tbody>

<!-- çµ„ä»˜å‡ºåº«æ•°åˆè¨ˆ -->
{% for item_name in item_names %}
<tr data-section="total_shipment" data-shift="day" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="category-label" rowspan="{% widthratio item_names|length 1 2 %}">
    çµ„ä»˜å‡ºåº«æ•°
  </th>
  <th class="shift-label" rowspan="{{ item_names|length }}">æ—¥å‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with item_data=date_info.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <span class="total-shipment">{{ item_data.total_shipment_day|default:"" }}</span>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- å¤œå‹¤ -->
{% for item_name in item_names %}
<tr class="night-shift" data-section="total_shipment" data-shift="night" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="shift-label" rowspan="{{ item_names|length }}">å¤œå‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with item_data=date_info.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <span class="total-shipment">{{ item_data.total_shipment_night|default:"" }}</span>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- å„ãƒ©ã‚¤ãƒ³å‡ºåº«æ•°ï¼ˆå‹•çš„ï¼‰ -->
{% for line_data in assembly_lines_data %}
<!-- {{ line_data.display_name }} -->
<!-- æ—¥å‹¤ -->
{% for item_name in line_data.items %}
<tr data-section="{{ line_data.data_section }}" data-shift="day" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="category-label" rowspan="{{ line_data.category_rowspan }}">
    {{ line_data.display_name }}
  </th>
  <th class="shift-label" rowspan="{{ line_data.shift_rowspan }}">æ—¥å‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with item_data=date_info.items|get_item:item_name %}
  {% with shipment_data=item_data.shipment_by_line|get_item:line_data.name %}
  {% with assembly_shipment_data=item_data.assembly_shipment_by_line|get_item:line_data.name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="production-input {{ line_data.css_class }}" value="{% if shipment_data.day is not None %}{{ shipment_data.day }}{% else %}{{ assembly_shipment_data.day|default:"" }}{% endif %}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"/>
  </td>
  {% endwith %}
  {% endwith %}
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- æ—¥å‹¤æ®‹æ¥­æ™‚é–“ -->
<tr data-section="{{ line_data.data_section }}" data-shift="day" data-type="overtime">
  <th class="vehicle-label">æ®‹æ¥­æ™‚é–“</th>
  {% for date_info in dates_data %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-date-index="{{ forloop.counter0 }}">
    <span class="overtime-hours" data-line="{{ line_data.name }}" data-shift="day" data-date-index="{{ forloop.counter0 }}">0</span>
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>

<!-- å¤œå‹¤ -->
{% for item_name in line_data.items %}
<tr class="night-shift" data-section="{{ line_data.data_section }}" data-shift="night" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="shift-label" rowspan="{{ line_data.shift_rowspan }}">å¤œå‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with item_data=date_info.items|get_item:item_name %}
  {% with shipment_data=item_data.shipment_by_line|get_item:line_data.name %}
  {% with assembly_shipment_data=item_data.assembly_shipment_by_line|get_item:line_data.name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="production-input {{ line_data.css_class }}" value="{% if shipment_data.night is not None %}{{ shipment_data.night }}{% else %}{{ assembly_shipment_data.night|default:"" }}{% endif %}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0" {% if date_info.is_weekend %}style="display:none;"{% endif %}/>
  </td>
  {% endwith %}
  {% endwith %}
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- å¤œå‹¤æ®‹æ¥­æ™‚é–“ -->
<tr class="night-shift" data-section="{{ line_data.data_section }}" data-shift="night" data-type="overtime">
  <th class="vehicle-label">æ®‹æ¥­æ™‚é–“</th>
  {% for date_info in dates_data %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-date-index="{{ forloop.counter0 }}">
    <span class="overtime-hours" data-line="{{ line_data.name }}" data-shift="night" data-date-index="{{ forloop.counter0 }}"{% if date_info.is_weekend %} style="display:none;"{% endif %}>0</span>
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>

{% endfor %}

</tbody>
</table>
</div>
</div>

{% include 'components/toast.html' %}

<!-- CSRFãƒˆãƒ¼ã‚¯ãƒ³ -->
{% csrf_token %}

<!-- ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã«æ¸¡ã™ -->
<script>
    const lineType = '{{ line_type }}';
    const year = {{ year }};
    const month = {{ month }};
    const tact1 = {{ tact_1 }};
    const tact2 = {{ tact_2 }};
    const itemLineInfo = {{ item_line_info|safe }};
    const itemMainLine = {{ item_main_line|safe }};
    const tactsData = {{ tacts_json|safe }};
    const datesData = {{ dates_data_json|safe }};
    const hasExistingData = {{ has_existing_data|yesno:"true,false" }};
</script>

<!-- å¤–éƒ¨JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
<script src="{% static 'js/vendor/jquery/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'js/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/vendor/select2/select2.min.js' %}"></script>
<script src="{% static 'js/toast.js' %}"></script>
<script src="{% static 'js/machining_shipment_adjustment.js' %}"></script>
</body>
</html>
