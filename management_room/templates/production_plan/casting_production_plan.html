{% load static %}
{% load dict_filters %}

<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>é‹³é€ ç”Ÿç”£ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« - {{ year }}å¹´{{ month }}æœˆ</title>
<link href="{% static 'css/vendor/bootstrap/bootstrap.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/select2/select2.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/select2/select2-bootstrap-5-theme.min.css' %}" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/production_plan.css' %}">
<link rel="stylesheet" href="{% static 'css/loading.css' %}">
<style>
/* æ®‹æ¥­inputã®åˆæœŸéè¡¨ç¤ºï¼ˆJavaScriptã‚ˆã‚Šã‚‚å…ˆã«é©ç”¨ï¼‰ */
td.weekend .overtime-input {
    display: none !important;
}
/* ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–ä¸­ã¯éè¡¨ç¤º */
#schedule-table.table-initializing {
    opacity: 0;
    pointer-events: none;
}
#schedule-table.table-ready {
    opacity: 1;
    pointer-events: auto;
    transition: opacity 0.4s ease;
}
</style>
</head>
<body class="assembly-plan">
<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆloading.jsã§ç®¡ç†ï¼‰ -->
<div id="loadingOverlay" class="loading-overlay visible">
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText"></div>
    </div>
</div>
<!-- loading.jsã‚’å³åº§ã«å®Ÿè¡Œã—ã¦Loading...ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ -->
<script src="{% static 'js/loading.js' %}"></script>
<div class="page-container">
    <div class="header-section">
        <div class="page-title">é‹³é€ ç”Ÿç”£ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
        <div class="controls-wrapper">
            <div class="left-controls">
                <div class="control-row">
                    <label for="line-select">ãƒ©ã‚¤ãƒ³ï¼š</label>
                    <select id="line-select" class="line-select select2">
                        {% for line_item in lines %}
                        <option value="{{ line_item.id }}" {% if line_item.id == line.id %}selected{% endif %}>{{ line_item.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="control-row">
                    <label for="target-month">å¯¾è±¡æœˆï¼š</label>
                    <input type="month" id="target-month" class="month-input" value="{{ year }}-{{ month|stringformat:'02d' }}">
                </div>
            </div>

            <div class="monthly-plan-card">
                <div class="monthly-plan-title">ğŸ“¦ æœˆæœ«åœ¨åº«</div>
                <div class="monthly-plan-grid">
                    {% for item in inventory_comparison %}
                        <div class="monthly-plan-item {% if item.difference < 0 %}shortage{% elif item.difference > 0 %}excess{% endif %}" data-item-name="{{ item.name }}" data-optimal-inventory="{{ item.optimal_inventory|default:0 }}">
                            <div class="monthly-plan-item-name">{{ item.name }}</div>
                            <div class="monthly-plan-item-quantity">
                                <span class="end-of-month-inventory">{{ item.end_of_month_inventory|default:0 }}</span> å°
                                <span class="monthly-plan-diff">
                                    ({% if item.difference > 0 %}+{% endif %}{{ item.difference|default:0 }})
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="right-controls">
                <button type="button" id="auto-btn" class="auto-btn">è‡ªå‹•</button>
                <button type="button" id="save-btn" class="save-btn">ä¿å­˜</button>
                <button type="button" id="excel-export-btn" class="excel-export-btn" onclick="exportToExcel()">Excelå‡ºåŠ›</button>
                <button type="button" id="main-btn" class="main-btn" onclick="window.location.href='/'">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸</button>
            </div>
        </div>
    </div>
<div class="table-container table-initializing" id="schedule-table" style="position: relative;">
<!-- é‡‘å‹å¼•ãç¶™ãã®çŸ¢å°è¡¨ç¤ºç”¨SVG -->
<svg id="inheritance-arrows" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: visible;">
    <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
            <polygon points="0 0, 10 3, 0 6" fill="#4CAF50" opacity="0.5" />
        </marker>
    </defs>
</svg>
<table>
<thead>
<tr class="time-check-row">
<th colspan="3" rowspan="3">è¨­å‚™</th>
{% for date_data in dates_data %}<th class="check-cell" data-date="{{ date_data.date|date:"n/j" }}" data-weekend="{% if date_data.is_weekend %}true{% else %}false{% endif %}" data-has-weekend-work="{% if date_data.has_weekend_work %}true{% else %}false{% endif %}" data-has-weekend-delivery="{% if date_data.has_weekend_delivery %}true{% else %}false{% endif %}" data-regular-hours="{% if date_data.is_regular_hours %}true{% else %}false{% endif %}" onclick="toggleCheck(this)"></th>
{% endfor %}
<th rowspan="3">æ—¥è¨ˆ/å¤œè¨ˆ</th>
<th rowspan="3">åˆè¨ˆ</th>
</tr>
<tr>
{% for date_data in dates_data %}<th>{{ date_data.date|date:"n/j" }}<br/>({% if date_data.weekday == 0 %}æœˆ{% elif date_data.weekday == 1 %}ç«{% elif date_data.weekday == 2 %}æ°´{% elif date_data.weekday == 3 %}æœ¨{% elif date_data.weekday == 4 %}é‡‘{% elif date_data.weekday == 5 %}åœŸ{% elif date_data.weekday == 6 %}æ—¥{% endif %})</th>
{% endfor %}
</tr>
<tr>
{% for date_data in dates_data %}<th{% if date_data.is_weekend %} class="weekend"{% endif %}><input type="number" class="operation-rate-input" data-date-index="{{ forloop.counter0 }}" step="0.01" min="0" max="100" placeholder="ç¨¼åƒç‡" value="{{ date_data.occupancy_rate }}"/></th>
{% endfor %}
</tr>
</thead>
<tbody>
<!-- å‡ºåº« -->
{% for item_name in item_names %}
<tr data-section="delivery" data-shift="day">
    {% if forloop.first %}
    <th class="category-label" rowspan="{{ item_total_rows }}">å‡ºåº«æ•°</th>
    <th class="shift-label" rowspan="{{ item_names|length }}">æ—¥å‹¤</th>
    {% endif %}
    <th class="vehicle-label">{{ item_name }}</th>
    {% for date_data in dates_data %}
    <td class="delivery-cell{% if date_data.is_weekend %} weekend{% endif %}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
        <input type="number" class="delivery-input" value="{{ date_data.shifts.day.items|get_item:item_name|get_item:'delivery' }}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0" readonly/>
    </td>
    {% endfor %}
    <td class="total-cell delivery-total" data-shift="day" data-item="{{ item_name }}">0</td>
    <td class="total-cell delivery-combined-total" data-item="{{ item_name }}">0</td>
</tr>
{% endfor %}
{% for item_name in item_names %}
<tr class="night-shift" data-section="delivery" data-shift="night">
    {% if forloop.first %}
    <th class="shift-label" rowspan="{{ item_names|length }}">å¤œå‹¤</th>
    {% endif %}
    <th class="vehicle-label">{{ item_name }}</th>
    {% for date_data in dates_data %}
    <td class="delivery-cell{% if date_data.is_weekend %} weekend{% endif %}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
        <input type="number" class="delivery-input" value="{{ date_data.shifts.night.items|get_item:item_name|get_item:'delivery' }}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"{% if date_data.is_weekend %} style="display:none;"{% endif %} readonly/>
    </td>
    {% endfor %}
    <td class="total-cell delivery-total" data-shift="night" data-item="{{ item_name }}">0</td>
    <td></td>
</tr>
{% endfor %}
<!-- ç”Ÿç”£å°æ•° -->
{% for item_name in item_names %}
<tr data-section="production" data-shift="day">
    {% if forloop.first %}
    <th class="category-label" rowspan="{{ item_total_rows }}">ç”Ÿç”£å°æ•°</th>
    <th class="shift-label" rowspan="{{ item_names|length }}">æ—¥å‹¤</th>
    {% endif %}
    <th class="vehicle-label">{{ item_name }}</th>
    {% for date_data in dates_data %}
    <td class="production-cell{% if date_data.is_weekend %} weekend{% endif %}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
        <input type="number" class="production-input" value="{{ date_data.shifts.day.items|get_item:item_name|get_item:'production' }}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0" readonly/>
    </td>
    {% endfor %}
    <td class="total-cell production-total" data-shift="day" data-item="{{ item_name }}">0</td>
    <td class="total-cell production-combined-total" data-item="{{ item_name }}">0</td>
</tr>
{% endfor %}
{% for item_name in item_names %}
<tr class="night-shift" data-section="production" data-shift="night">
    {% if forloop.first %}
    <th class="shift-label" rowspan="{{ item_names|length }}">å¤œå‹¤</th>
    {% endif %}
    <th class="vehicle-label">{{ item_name }}</th>
    {% for date_data in dates_data %}
    <td class="production-cell{% if date_data.is_weekend %} weekend{% endif %}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
        <input type="number" class="production-input" value="{{ date_data.shifts.night.items|get_item:item_name|get_item:'production' }}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"{% if date_data.is_weekend %} style="display:none;"{% endif %} readonly/>
    </td>
    {% endfor %}
    <td class="total-cell production-total" data-shift="night" data-item="{{ item_name }}">0</td>
    <td></td>
</tr>
{% endfor %}
<!-- åœ¨åº« -->
{% for item_name in item_names %}
<tr data-section="inventory" data-shift="day">
    {% if forloop.first %}
    <th class="category-label" rowspan="{{ item_total_rows }}">åœ¨åº«æ•°</th>
    <th class="shift-label" rowspan="{{ item_names|length }}">æ—¥å‹¤</th>
    {% endif %}
    <th class="vehicle-label">{{ item_name }}</th>
    {% for date_data in dates_data %}
    <td class="inventory-cell{% if date_data.is_weekend %} weekend{% endif %}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
        <input type="number" class="inventory-input" value="{{ date_data.shifts.day.items|get_item:item_name|get_item:'inventory' }}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"/>
    </td>
    {% endfor %}
    <td></td>
    <td></td>
</tr>
{% endfor %}
{% for item_name in item_names %}
<tr class="night-shift" data-section="inventory" data-shift="night">
    {% if forloop.first %}
    <th class="shift-label" rowspan="{{ item_names|length }}">å¤œå‹¤</th>
    {% endif %}
    <th class="vehicle-label">{{ item_name }}</th>
    {% for date_data in dates_data %}
    <td class="inventory-cell{% if date_data.is_weekend %} weekend{% endif %}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
        <input type="number" class="inventory-input" value="{{ date_data.shifts.night.items|get_item:item_name|get_item:'inventory' }}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"{% if date_data.is_weekend %} style="display:none;"{% endif %}/>
    </td>
    {% endfor %}
    <td></td>
    <td class="total-cell inventory-difference-total" data-item="{{ item_name }}">0</td>
</tr>
{% endfor %}
<!-- ç”Ÿç”£è¨ˆç”» -->
<tr class="section-date-header">
<th colspan="3"></th>
{% for date_data in dates_data %}<th{% if date_data.is_weekend %} class="weekend"{% endif %}>{{ date_data.date|date:"n/j" }}<br/>({% if date_data.weekday == 0 %}æœˆ{% elif date_data.weekday == 1 %}ç«{% elif date_data.weekday == 2 %}æ°´{% elif date_data.weekday == 3 %}æœ¨{% elif date_data.weekday == 4 %}é‡‘{% elif date_data.weekday == 5 %}åœŸ{% elif date_data.weekday == 6 %}æ—¥{% endif %})</th>{% endfor %}
<th></th>
<th></th>
</tr>
<tr class="reusable-molds-row">
<td colspan="100%" style="text-align: center; padding: 8px; background-color: #f8f9fa; border: 1px solid #ddd;">
    <div class="reusable-molds-inline" id="reusable-molds-list">
        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>
</td>
</tr>
{% for machine in machines %}
<tr data-section="production_plan" data-shift="day" data-machine-index="{{ forloop.counter0 }}">
    {% if forloop.first %}
    <th class="category-label" rowspan="{{ machine_total_rows }}">ç”Ÿç”£è¨ˆç”»</th>
    <th class="shift-label" rowspan="{{ machines|length }}">æ—¥å‹¤</th>
    {% endif %}
    <th class="facility-number">{{ machine.name }}</th>
    {% for date_data in dates_data %}
    {% with machine_data=date_data.shifts.day.machines|get_item:machine.name %}
    <td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}">
        {% if machine_data.items %}
        <div class="select-container">
            <select class="vehicle-select" data-shift="day" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}" data-vehicle="{{ machine_data.selected_item }}">
                <option value="">-</option>
                {% for item in machine_data.items %}
                <option value="{{ item }}"{% if item == machine_data.selected_item %} selected{% endif %}>{{ item }}</option>
                {% endfor %}
            </select>
            <span class="mold-count-display{% if machine_data.mold_count == -1 %} manual-block{% endif %}" data-shift="day" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}" data-reset="false" data-inherited="false" data-manual-block="{% if machine_data.mold_count == -1 %}true{% else %}false{% endif %}"{% if machine_data.is_prev_month_mold %} data-prev-month-mold="true" data-prev-month-count="{{ machine_data.prev_month_mold_count }}" data-prev-month-item="{{ machine_data.prev_month_item_name }}"{% endif %}>{% if machine_data.mold_count == -1 %}1{% elif machine_data.mold_count %}{{ machine_data.mold_count }}{% endif %}</span>
        </div>
        {% endif %}
    </td>
    {% endwith %}
    {% endfor %}
    <td></td>
    <td></td>
</tr>
{% endfor %}
{% for machine in machines %}
<tr class="night-shift" data-section="production_plan" data-shift="night" data-machine-index="{{ forloop.counter0 }}">
    {% if forloop.first %}
    <th class="shift-label" rowspan="{{ machines|length }}">å¤œå‹¤</th>
    {% endif %}
    <th class="facility-number">{{ machine.name }}</th>
    {% for date_data in dates_data %}
    {% with machine_data=date_data.shifts.night.machines|get_item:machine.name %}
    <td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}">
        {% if not date_data.is_weekend and machine_data.items %}
        <div class="select-container">
            <select class="vehicle-select" data-shift="night" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}" data-vehicle="{{ machine_data.selected_item }}">
                <option value="">-</option>
                {% for item in machine_data.items %}
                <option value="{{ item }}"{% if item == machine_data.selected_item %} selected{% endif %}>{{ item }}</option>
                {% endfor %}
            </select>
            <span class="mold-count-display{% if machine_data.mold_count == -1 %} manual-block{% endif %}" data-shift="night" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}" data-reset="false" data-inherited="false" data-manual-block="{% if machine_data.mold_count == -1 %}true{% else %}false{% endif %}">{% if machine_data.mold_count == -1 %}1{% elif machine_data.mold_count %}{{ machine_data.mold_count }}{% endif %}</span>
        </div>
        {% endif %}
    </td>
    {% endwith %}
    {% endfor %}
    <td></td>
    <td></td>
</tr>
{% endfor %}
<!-- é‡‘å‹äº¤æ› -->
{% for machine in machines %}
<tr data-section="mold_change" data-shift="day" data-machine-index="{{ forloop.counter0 }}">
{% if forloop.first %}<th class="category-label" rowspan="{{ machine_total_rows }}">é‡‘å‹äº¤æ›</th><th class="shift-label" rowspan="{{ machines|length }}">æ—¥å‹¤</th>{% endif %}
<th class="facility-number">{{ machine.name }}</th>
{% for date_data in dates_data %}
{% with machine_data=date_data.shifts.day.machines|get_item:machine.name %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}">
<input class="mold-change-input" max="480" min="0" step="5" type="number" value="{{ machine_data.mold_change }}" data-shift="day" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}"/>
</td>
{% endwith %}
{% endfor %}
<td class="total-cell mold-change-total" data-shift="day" data-machine-index="{{ forloop.counter0 }}">0</td>
<td class="total-cell mold-change-combined-total" data-machine-index="{{ forloop.counter0 }}">0</td>
</tr>
{% endfor %}
{% for machine in machines %}
<tr class="night-shift" data-section="mold_change" data-shift="night" data-machine-index="{{ forloop.counter0 }}">
{% if forloop.first %}<th class="shift-label" rowspan="{{ machines|length }}">å¤œå‹¤</th>{% endif %}
<th class="facility-number">{{ machine.name }}</th>
{% for date_data in dates_data %}
{% with machine_data=date_data.shifts.night.machines|get_item:machine.name %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}">
{% if not date_data.is_weekend %}<input class="mold-change-input" max="480" min="0" step="5" type="number" value="{{ machine_data.mold_change }}" data-shift="night" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}"/>{% endif %}
</td>
{% endwith %}
{% endfor %}
<td class="total-cell mold-change-total" data-shift="night" data-machine-index="{{ forloop.counter0 }}">0</td>
<td></td>
</tr>
{% endfor %}
<!-- æ®‹æ¥­æ™‚é–“ -->
{% for machine in machines %}
<tr data-section="overtime" data-shift="day" data-machine-index="{{ forloop.counter0 }}">
{% if forloop.first %}<th class="category-label" rowspan="{{ machine_total_rows }}">æ®‹æ¥­è¨ˆç”»</th><th class="shift-label" rowspan="{{ machines|length }}">æ—¥å‹¤</th>{% endif %}
<th class="facility-number">{{ machine.name }}</th>
{% for date_data in dates_data %}
{% with machine_data=date_data.shifts.day.machines|get_item:machine.name %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}">
<input class="overtime-input" max="120" min="0" step="5" type="number" value="{{ machine_data.overtime }}" data-shift="day" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}"{% if date_data.is_weekend and not date_data.has_weekend_work or date_data.has_weekend_work or date_data.is_regular_hours %} style="display: none"{% endif %}/>
</td>
{% endwith %}
{% endfor %}
<td class="total-cell overtime-total" data-shift="day" data-machine-index="{{ forloop.counter0 }}">0</td>
<td class="total-cell overtime-combined-total" data-machine-index="{{ forloop.counter0 }}">0</td>
</tr>
{% endfor %}
{% for machine in machines %}
<tr class="night-shift" data-section="overtime" data-shift="night" data-machine-index="{{ forloop.counter0 }}">
{% if forloop.first %}<th class="shift-label" rowspan="{{ machines|length }}">å¤œå‹¤</th>{% endif %}
<th class="facility-number">{{ machine.name }}</th>
{% for date_data in dates_data %}
{% with machine_data=date_data.shifts.night.machines|get_item:machine.name %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}">
<input class="overtime-input" max="60" min="0" step="5" type="number" value="{{ machine_data.overtime }}" data-shift="night" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}"{% if date_data.is_weekend and not date_data.has_weekend_work or date_data.has_weekend_work %} style="display: none"{% endif %}/>
</td>
{% endwith %}
{% endfor %}
<td class="total-cell overtime-total" data-shift="night" data-machine-index="{{ forloop.counter0 }}">0</td>
<td></td>
</tr>
{% endfor %}
<!-- è¨ˆç”»åœæ­¢ -->
{% for machine in machines %}
<tr data-section="stop_time" data-shift="day" data-machine-index="{{ forloop.counter0 }}">
{% if forloop.first %}<th class="category-label" rowspan="{{ machine_total_rows }}">è¨ˆç”»åœæ­¢</th><th class="shift-label" rowspan="{{ machines|length }}">æ—¥å‹¤</th>{% endif %}
<th class="facility-number">{{ machine.name }}</th>
{% for date_data in dates_data %}
{% with machine_data=date_data.shifts.day.machines|get_item:machine.name %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}">
<input class="stop-time-input" max="480" min="0" step="5" type="number" value="{{ machine_data.stop_time }}" data-shift="day" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}"/>
</td>
{% endwith %}
{% endfor %}
<td class="total-cell stop-time-total" data-shift="day" data-machine-index="{{ forloop.counter0 }}">0</td>
<td class="total-cell stop-time-combined-total" data-machine-index="{{ forloop.counter0 }}">0</td>
</tr>
{% endfor %}
{% for machine in machines %}
<tr class="night-shift" data-section="stop_time" data-shift="night" data-machine-index="{{ forloop.counter0 }}">
{% if forloop.first %}<th class="shift-label" rowspan="{{ machines|length }}">å¤œå‹¤</th>{% endif %}
<th class="facility-number">{{ machine.name }}</th>
{% for date_data in dates_data %}
{% with machine_data=date_data.shifts.night.machines|get_item:machine.name %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}">
{% if not date_data.is_weekend %}<input class="stop-time-input" max="480" min="0" step="5" type="number" value="{{ machine_data.stop_time }}" data-shift="night" data-date-index="{{ forloop.counter0 }}" data-machine-index="{{ forloop.parentloop.counter0 }}"/>{% endif %}
</td>
{% endwith %}
{% endfor %}
<td class="total-cell stop-time-total" data-shift="night" data-machine-index="{{ forloop.counter0 }}">0</td>
<td></td>
</tr>
{% endfor %}
<!-- æº¶æ¹¯ -->
<tr data-section="molten_metal" data-shift="day">
<th class="category-label" rowspan="2">æº¶æ¹¯</th>
<th class="shift-label" colspan="2">æ—¥å‹¤</th>
{% for date_data in dates_data %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}"></td>
{% endfor %}
<td></td>
<td></td>
</tr>
<tr class="night-shift" data-section="molten_metal" data-shift="night">
<th class="shift-label" colspan="2">å¤œå‹¤</th>
{% for date_data in dates_data %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}"></td>
{% endfor %}
<td></td>
<td></td>
</tr>
<!-- ãƒãƒƒãƒˆæ•° -->
<tr data-section="pot_count" data-shift="day">
<th class="category-label" rowspan="2">ãƒãƒƒãƒˆæ•°</th>
<th class="shift-label" colspan="2">æ—¥å‹¤</th>
{% for date_data in dates_data %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}"></td>
{% endfor %}
<td></td>
<td></td>
</tr>
<tr class="night-shift" data-section="pot_count" data-shift="night">
<th class="shift-label" colspan="2">å¤œå‹¤</th>
{% for date_data in dates_data %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}"></td>
{% endfor %}
<td></td>
<td></td>
</tr>
<!-- ä¸­å­ -->
{% for item_name in item_names %}
<tr data-section="core" data-item="{{ item_name }}">
{% if forloop.first %}
<th class="category-label" rowspan="{{ item_names|length }}">ä¸­å­</th>
{% endif %}
<th class="shift-label" colspan="2">{{ item_name }}</th>
{% for date_data in dates_data %}
<td{% if date_data.is_weekend %} class="weekend"{% endif %} data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}"></td>
{% endfor %}
<td></td>
<td></td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>

{% include 'components/toast.html' %}

<!-- CSRFãƒˆãƒ¼ã‚¯ãƒ³ -->
{% csrf_token %}

<!-- ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã«æ¸¡ã™ -->
<script>
    // å“ç•ªãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚¯ãƒˆã¨è‰¯å“ç‡ï¼‰
    itemData = {{ item_data_json|safe }};

    // å‰æœˆæœ€çµ‚åœ¨åº«
    previousMonthInventory = {{ previous_month_inventory_json|safe }};

    // å‰æœˆã®æœ€å¾Œã®5ç›´åˆ†ã®ç”Ÿç”£è¨ˆç”»ï¼ˆé€£ç¶šç”Ÿç”£ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
    previousMonthProductionPlans = {{ previous_month_production_plans_json|safe }};

    // å‰æœˆã®ä½¿ç”¨å¯èƒ½é‡‘å‹æ•°
    prevUsableMolds = {{ prev_usable_molds_json|safe }};

    // ãƒ©ã‚¤ãƒ³ã®æ®µå–æ™‚é–“ï¼ˆå‹æ›¿ãˆæ™‚é–“ï¼‰ï¼ˆåˆ†ï¼‰
    changeoverTime = {{ changeover_time }};
</script>

<!-- å¤–éƒ¨JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
<script src="{% static 'js/vendor/jquery/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'js/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/vendor/select2/select2.min.js' %}"></script>
<script src="{% static 'js/toast.js' %}"></script>
<script src="{% static 'js/casting_production_plan.js' %}"></script>

<script>
// Excelå‡ºåŠ›é–¢æ•°
function exportToExcel() {
    const targetMonthInput = document.getElementById('target-month');
    if (!targetMonthInput || !targetMonthInput.value) {
        showToast('error', 'å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    const [year, month] = targetMonthInput.value.split('-');
    const url = `/management_room/production-plan/excel-export/?year=${year}&month=${month}`;

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    window.location.href = url;
}
</script>
</body>
</html>
