{% load static %}
{% load dict_filters %}

<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>加工生産スケジュール - {{ year }}年{{ month }}月</title>
<link href="{% static 'css/vendor/bootstrap/bootstrap.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/select2/select2.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/select2/select2-bootstrap-5-theme.min.css' %}" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/production_plan.css' %}">
</head>
<body class="assembly-plan">
<div class="page-container">
    <div class="header-section">
        <div class="page-title">加工生産スケジュール</div>
        <div class="controls-wrapper">
            <div class="left-controls">
                <div class="control-row">
                    <label for="line-select">ライン：</label>
                    <select id="line-select" class="line-select select2">
                        {% for line_item in lines %}
                        <option value="{{ line_item.id }}" {% if line_item.id == line.id %}selected{% endif %}>{{ line_item.assembly_name }} - {{ line_item.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="control-row">
                    <label for="target-month">対象月：</label>
                    <input type="month" id="target-month" class="month-input" value="{{ year }}-{{ month|stringformat:'02d' }}">
                </div>
            </div>

            <div class="right-controls">
                <button type="button" id="save-btn" class="save-btn">保存</button>
                <button type="button" id="main-btn" class="main-btn" onclick="window.location.href='/'">メインページ</button>
            </div>
        </div>
    </div>
<div class="table-container" id="schedule-table">
<table>
<thead>
<tr class="time-check-row">
<th colspan="3" rowspan="3">完成品番</th>
<!-- 定時、休出フラグ -->
{% for date_info in dates_data %}
<th class="check-cell" data-date="{{ month }}/{{ date_info.day }}" data-date-index="{{ forloop.counter0 }}" data-weekend="{% if date_info.is_weekend %}true{% else %}false{% endif %}" data-has-weekend-work="{% if date_info.has_data %}true{% else %}false{% endif %}" data-has-assembly-weekend-work="{% if date_info.has_assembly_weekend_work %}true{% else %}false{% endif %}" data-regular-hours="{% if date_info.regular_working_hours %}true{% else %}false{% endif %}" onclick="toggleCheck(this)">{% if date_info.regular_working_hours %}定時{% elif date_info.is_weekend and date_info.has_data %}休出{% endif %}</th>
{% endfor %}
<th rowspan="3">月計(直)</th>
<th rowspan="3">月計</th>
</tr>

<!-- 日付 -->
<tr>
{% for date_info in dates_data %}
<th>{{ month }}/{{ date_info.day }}<br/>({% if date_info.weekday == 0 %}月{% elif date_info.weekday == 1 %}火{% elif date_info.weekday == 2 %}水{% elif date_info.weekday == 3 %}木{% elif date_info.weekday == 4 %}金{% elif date_info.weekday == 5 %}土{% elif date_info.weekday == 6 %}日{% endif %})</th>
{% endfor %}
</tr>

<!-- 稼働率 -->
<tr>
{% for date_info in dates_data %}<th{% if date_info.is_weekend %} class="weekend"{% endif %}><input type="number" class="operation-rate-input" data-date-index="{{ forloop.counter0 }}" step="0.01" min="0" max="100" placeholder="稼働率" value="{{ date_info.occupancy_rate }}"/></th>
{% endfor %}
</tr>
</thead>
<tbody>

<!-- 出庫数 -->
{% for item_name in item_names %}
<tr data-section="shipment" data-shift="day" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="category-label" rowspan="{{ production_total_rows }}" style="cursor:move;">
    出庫数
  </th>
  <!-- 日勤 -->
  <th class="shift-label" rowspan="{{ item_names|length }}">日勤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with day_item=date_info.shifts.day.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="shipment-input" value="{% if day_item.shipment is not None %}{{ day_item.shipment }}{% endif %}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total" data-item="{{ item_name }}"></td>
  <td class="daily-total shipment-daily-total" data-item="{{ item_name }}"></td>
</tr>
{% endfor %}

<!-- 夜勤 -->
{% for item_name in item_names %}
<tr class="night-shift" data-section="shipment" data-shift="night" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="shift-label" rowspan="{{ item_names|length }}">夜勤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with night_item=date_info.shifts.night.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="shipment-input" value="{% if night_item.shipment is not None %}{{ night_item.shipment }}{% endif %}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"{% if date_info.is_weekend %} style="display:none;"{% endif %}/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- 生産数 -->
{% for item_name in item_names %}
<tr data-section="production" data-shift="day" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="category-label" rowspan="{{ production_total_rows }}" style="cursor:move;">
    生産数
  </th>

  <!-- 日勤 -->
  <th class="shift-label" rowspan="{{ item_names|length }}">日勤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with day_item=date_info.shifts.day.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="production-input" value="{% if day_item.production_quantity is not None %}{{ day_item.production_quantity }}{% endif %}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total" data-item="{{ item_name }}"></td>
  <td class="daily-total" data-item="{{ item_name }}"></td>
</tr>
{% endfor %}

<!-- 夜勤 -->
{% for item_name in item_names %}
<tr class="night-shift" data-section="production" data-shift="night" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="shift-label" rowspan="{{ item_names|length }}">夜勤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with night_item=date_info.shifts.night.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="production-input" value="{% if night_item.production_quantity is not None %}{{ night_item.production_quantity }}{% endif %}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"{% if date_info.is_weekend %} style="display:none;"{% endif %}/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- 在庫数 -->
{% for item_name in item_names %}
<tr data-section="stock" data-shift="day" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="category-label" rowspan="{{ production_total_rows }}" style="cursor:move;">
    在庫数
  </th>
  <!-- 日勤 -->
  <th class="shift-label" rowspan="{{ item_names|length }}">日勤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with day_item=date_info.shifts.day.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="stock-input" value="{% if day_item.stock is not None %}{{ day_item.stock }}{% endif %}"{% if day_item.stock is not None %} data-has-db-value="true"{% endif %} data-shift="day" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0" readonly/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total" data-item="{{ item_name }}"></td>
  <td class="daily-total stock-difference" data-item="{{ item_name }}"></td>
</tr>
{% endfor %}

<!-- 夜勤 -->
{% for item_name in item_names %}
<tr class="night-shift" data-section="stock" data-shift="night" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="shift-label" rowspan="{{ item_names|length }}">夜勤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in dates_data %}
  {% with night_item=date_info.shifts.night.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="stock-input" value="{% if night_item.stock is not None %}{{ night_item.stock }}{% endif %}"{% if night_item.stock is not None %} data-has-db-value="true"{% endif %} data-shift="night" data-item="{{ item_name }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"{% if date_info.is_weekend %} style="display:none;"{% endif %} readonly/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- 残業計画 -->
<tr data-section="overtime" data-shift="day">
  <th class="category-label" rowspan="2" style="cursor:move;">
    残業計画
  </th>

  <!-- 日勤 -->
  <th class="shift-label" colspan="2">日勤</th>
  {% for date_info in dates_data %}
  <td{% if date_info.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}">
    <input class="overtime-input" max="120" min="0" step="5" type="number" value="{{ date_info.shifts.day.overtime }}" data-shift="day" data-date-index="{{ forloop.counter0 }}"/>
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>

<!-- 夜勤 -->
<tr class="night-shift" data-section="overtime" data-shift="night">
  <th class="shift-label" colspan="2">夜勤</th>
  {% for date_info in dates_data %}
  <td{% if date_info.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}">
    {% if not date_info.is_weekend %}
    <input class="overtime-input" max="60" min="0" step="5" type="number" value="{{ date_info.shifts.night.overtime }}" data-shift="night" data-date-index="{{ forloop.counter0 }}"/>
    {% endif %}
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>

<!-- 計画停止 -->
<tr data-section="stop_time" data-shift="day">
  <th class="category-label" rowspan="2" style="cursor:move;">
    計画停止
  </th>

  <!-- 日勤 -->
  <th class="shift-label" colspan="2">日勤</th>
  {% for date_info in dates_data %}
  <td{% if date_info.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}">
    <input class="stop-time-input" max="480" min="0" step="5" type="number" value="{{ date_info.shifts.day.stop_time }}" data-shift="day" data-date-index="{{ forloop.counter0 }}"/>
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>

<!-- 夜勤 -->
<tr class="night-shift" data-section="stop_time" data-shift="night">
  <th class="shift-label" colspan="2">夜勤</th>
  {% for date_info in dates_data %}
  <td{% if date_info.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}">
    {% if not date_info.is_weekend %}
    <input class="stop-time-input" max="480" min="0" step="5" type="number" value="{{ date_info.shifts.night.stop_time }}" data-shift="night" data-date-index="{{ forloop.counter0 }}"/>
    {% endif %}
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
</tbody>
</table>
</div>
</div>

{% include 'components/toast.html' %}

<!-- CSRFトークン -->
{% csrf_token %}

<!-- データをJavaScriptに渡す -->
<script>
    // 品番データ（タクト）
    itemData = {{ item_data_json|safe }};
    // 前月末の在庫データ
    previousMonthStocks = {{ previous_month_stocks_json|safe }};
</script>

<!-- 外部JavaScriptファイルを読み込む -->
<script src="{% static 'js/vendor/jquery/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'js/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/vendor/select2/select2.min.js' %}"></script>
<script src="{% static 'js/toast.js' %}"></script>
<script src="{% static 'js/machining_production_plan.js' %}"></script>
</body>
</html>
