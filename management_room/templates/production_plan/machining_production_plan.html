{% load static %}
{% load dict_filters %}

<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>åŠ å·¥ç”Ÿç”£ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« - {{ year }}å¹´{{ month }}æœˆ</title>
<link href="{% static 'css/vendor/bootstrap/bootstrap.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/select2/select2.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/select2/select2-bootstrap-5-theme.min.css' %}" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/production_plan.css' %}">
<link rel="stylesheet" href="{% static 'css/loading.css' %}">
</head>
<body class="assembly-plan">
<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆloading.jsã§ç®¡ç†ï¼‰ -->
<div id="loadingOverlay" class="loading-overlay visible">
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText"></div>
    </div>
</div>
<!-- loading.jsã‚’å³åº§ã«å®Ÿè¡Œã—ã¦Loading...ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ -->
<script src="{% static 'js/loading.js' %}"></script>
<div class="page-container">
    <div class="header-section">
        <div class="page-title">åŠ å·¥ç”Ÿç”£ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
        <div class="controls-wrapper">
            <div class="left-controls">
                <div class="control-row">
                    <label for="line-select">ãƒ©ã‚¤ãƒ³ï¼š</label>
                    <select id="line-select" class="line-select select2">
                        {% for line_name_item in line_names_list %}
                        <option value="{{ line_name_item }}" {% if line_name_item == line_name %}selected{% endif %}>
                            {{ line_name_item }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="control-row">
                    <label for="target-month">å¯¾è±¡æœˆï¼š</label>
                    <input type="month" id="target-month" class="month-input" value="{{ year }}-{{ month|stringformat:'02d' }}">
                </div>
            </div>

            <div class="monthly-plan-card">
                <div class="monthly-plan-title">ğŸ“¦ æœˆæœ«åœ¨åº«</div>
                <div class="monthly-plan-grid">
                    {% for item in inventory_comparison %}
                        <div class="monthly-plan-item {% if item.difference < 0 %}shortage{% elif item.difference > 0 %}excess{% endif %}" data-item-name="{{ item.name }}" data-optimal-inventory="{{ item.optimal_inventory|default:0 }}">
                            <div class="monthly-plan-item-name">{{ item.name }}</div>
                            <div class="monthly-plan-item-quantity">
                                <span class="end-of-month-stock">{{ item.end_of_month_stock|default:0 }}</span> å°
                                <span class="monthly-plan-diff">
                                    ({% if item.difference > 0 %}+{% endif %}{{ item.difference|default:0 }})
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="right-controls">
                <button type="button" id="save-btn" class="save-btn">ä¿å­˜</button>
                <button type="button" id="excel-export-btn" class="excel-export-btn" onclick="exportToExcel()">Excelå‡ºåŠ›</button>
                <button type="button" class="casting-plan-btn" onclick="goToCastingPlan()">é‹³é€ ç”Ÿç”£è¨ˆç”»</button>
                <button type="button" id="main-btn" class="main-btn" onclick="window.location.href='/'">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸</button>
            </div>
        </div>
    </div>
<div class="table-container" id="schedule-table">
{% for line_data in lines_data %}
{% with line_index=forloop.counter0 %}
{% if not forloop.first %}<div style="margin-top: 40px;"></div>{% endif %}
<h3 style="margin: 20px 0 10px 0; font-size: 18px; font-weight: bold;">
  {{ line_data.assembly_name }} - {{ line_name }}
</h3>
<table data-line-index="{{ line_index }}" data-assembly-name="{{ line_data.assembly_name }}">
<thead>
<tr class="time-check-row">
<th colspan="3" rowspan="3">å®Œæˆå“ç•ª</th>
<!-- å®šæ™‚ã€ä¼‘å‡ºãƒ•ãƒ©ã‚° -->
{% for date_info in line_data.dates_data %}
<th class="check-cell" data-date="{{ month }}/{{ date_info.day }}" data-date-index="{{ forloop.counter0 }}" data-line-index="{{ line_index }}" data-weekend="{% if date_info.is_weekend %}true{% else %}false{% endif %}" data-has-weekend-work="{% if date_info.has_data %}true{% else %}false{% endif %}" data-has-assembly-weekend-work="{% if date_info.has_assembly_weekend_work %}true{% else %}false{% endif %}" data-regular-hours="{% if date_info.regular_working_hours %}true{% else %}false{% endif %}" onclick="toggleCheck(this)">{% if date_info.regular_working_hours %}å®šæ™‚{% elif date_info.is_weekend and date_info.has_data %}ä¼‘å‡º{% endif %}</th>
{% endfor %}
<th rowspan="3">æœˆè¨ˆ(ç›´)</th>
<th rowspan="3">æœˆè¨ˆ</th>
</tr>

<!-- æ—¥ä»˜ -->
<tr>
{% for date_info in line_data.dates_data %}
<th data-date-index="{{ forloop.counter0 }}">{{ month }}/{{ date_info.day }}<br/>({% if date_info.weekday == 0 %}æœˆ{% elif date_info.weekday == 1 %}ç«{% elif date_info.weekday == 2 %}æ°´{% elif date_info.weekday == 3 %}æœ¨{% elif date_info.weekday == 4 %}é‡‘{% elif date_info.weekday == 5 %}åœŸ{% elif date_info.weekday == 6 %}æ—¥{% endif %})</th>
{% endfor %}
</tr>

<!-- ç¨¼åƒç‡ -->
<tr>
{% for date_info in line_data.dates_data %}<th{% if date_info.is_weekend %} class="weekend"{% endif %} data-date-index="{{ forloop.counter0 }}"><input type="number" class="operation-rate-input" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}" step="0.01" min="0" max="100" placeholder="ç¨¼åƒç‡" value="{{ date_info.occupancy_rate }}"/></th>
{% endfor %}
</tr>
</thead>
<tbody>

<!-- å‡ºåº«æ•° -->
{% for item_name in line_data.item_names %}
<tr data-section="shipment" data-shift="day" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="category-label" rowspan="{{ line_data.rowspan_count }}">
    å‡ºåº«æ•°
  </th>
  <!-- æ—¥å‹¤ -->
  <th class="shift-label" rowspan="{{ line_data.item_length }}">æ—¥å‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in line_data.dates_data %}
  {% with day_item=date_info.shifts.day.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="day" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="shipment-input" value="{% if day_item.shipment is not None %}{{ day_item.shipment }}{% endif %}" data-shift="day" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total" data-item="{{ item_name }}"></td>
  <td class="daily-total shipment-daily-total" data-item="{{ item_name }}"></td>
</tr>
{% endfor %}

<!-- å¤œå‹¤ -->
{% for item_name in line_data.item_names %}
<tr class="night-shift" data-section="shipment" data-shift="night" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="shift-label" rowspan="{{ line_data.item_length }}">å¤œå‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in line_data.dates_data %}
  {% with night_item=date_info.shifts.night.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="night" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="shipment-input" value="{% if night_item.shipment is not None %}{{ night_item.shipment }}{% endif %}" data-shift="night" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"{% if date_info.is_weekend %} style="display:none;"{% endif %}/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- ç”Ÿç”£æ•° -->
{% for item_name in line_data.item_names %}
<tr data-section="production" data-shift="day" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="category-label" rowspan="{{ line_data.rowspan_count }}">
    ç”Ÿç”£æ•°
  </th>

  <!-- æ—¥å‹¤ -->
  <th class="shift-label" rowspan="{{ line_data.item_length }}">æ—¥å‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in line_data.dates_data %}
  {% with day_item=date_info.shifts.day.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="day" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="production-input" value="{% if day_item.production_quantity is not None %}{{ day_item.production_quantity }}{% endif %}"{% if day_item.production_quantity is not None %} data-has-db-value="true"{% endif %} data-shift="day" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total" data-item="{{ item_name }}"></td>
  <td class="daily-total" data-item="{{ item_name }}"></td>
</tr>
{% endfor %}

<!-- å¤œå‹¤ -->
{% for item_name in line_data.item_names %}
<tr class="night-shift" data-section="production" data-shift="night" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="shift-label" rowspan="{{ line_data.item_length }}">å¤œå‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in line_data.dates_data %}
  {% with night_item=date_info.shifts.night.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="night" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="production-input" value="{% if night_item.production_quantity is not None %}{{ night_item.production_quantity }}{% endif %}"{% if night_item.production_quantity is not None %} data-has-db-value="true"{% endif %} data-shift="night" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"{% if date_info.is_weekend %} style="display:none;"{% endif %}/>
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- åœ¨åº«æ•° -->
{% for item_name in line_data.item_names %}
<tr data-section="stock" data-shift="day" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="category-label" rowspan="{{ line_data.rowspan_count }}">
    åœ¨åº«æ•°
  </th>
  <!-- æ—¥å‹¤ -->
  <th class="shift-label" rowspan="{{ line_data.item_length }}">æ—¥å‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in line_data.dates_data %}
  {% with day_item=date_info.shifts.day.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="day" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="stock-input" value="{% if day_item.stock is not None %}{{ day_item.stock }}{% endif %}"{% if day_item.stock is not None %} data-has-db-value="true"{% endif %} data-shift="day" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0" />
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total" data-item="{{ item_name }}"></td>
  <td class="daily-total stock-difference" data-item="{{ item_name }}"></td>
</tr>
{% endfor %}

<!-- å¤œå‹¤ -->
{% for item_name in line_data.item_names %}
<tr class="night-shift" data-section="stock" data-shift="night" data-item="{{ item_name }}">
  {% if forloop.first %}
  <th class="shift-label" rowspan="{{ line_data.item_length }}">å¤œå‹¤</th>
  {% endif %}
  <th class="vehicle-label">{{ item_name }}</th>
  {% for date_info in line_data.dates_data %}
  {% with night_item=date_info.shifts.night.items|get_item:item_name %}
  <td class="production-cell{% if date_info.is_weekend %} weekend{% endif %}" data-shift="night" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}">
    <input type="number" class="stock-input" value="{% if night_item.stock is not None %}{{ night_item.stock }}{% endif %}"{% if night_item.stock is not None %} data-has-db-value="true"{% endif %} data-shift="night" data-item="{{ item_name }}" data-line-index="{{ line_index }}" data-date-index="{{ forloop.counter0 }}" step="1" min="0"{% if date_info.is_weekend %} style="display:none;"{% endif %} />
  </td>
  {% endwith %}
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
{% endfor %}

<!-- æ®‹æ¥­è¨ˆç”» -->
<tr data-section="overtime" data-shift="day">
  <th class="category-label" rowspan="2" style="cursor:move;">
    æ®‹æ¥­è¨ˆç”»
  </th>

  <!-- æ—¥å‹¤ -->
  <th class="shift-label" colspan="2">æ—¥å‹¤</th>
  {% for date_info in line_data.dates_data %}
  <td{% if date_info.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}">
    <input class="overtime-input" data-line-index="{{ line_index }}" max="120" min="0" step="5" type="number" value="{% if date_info.shifts.day.overtime is not None %}{{ date_info.shifts.day.overtime }}{% endif %}"{% if date_info.shifts.day.overtime %} data-has-db-value="true"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}"/>
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>

<!-- å¤œå‹¤ -->
<tr class="night-shift" data-section="overtime" data-shift="night">
  <th class="shift-label" colspan="2">å¤œå‹¤</th>
  {% for date_info in line_data.dates_data %}
  <td{% if date_info.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}">
    {% if not date_info.is_weekend %}
    <input class="overtime-input" data-line-index="{{ line_index }}" max="60" min="0" step="5" type="number" value="{% if date_info.shifts.night.overtime is not None %}{{ date_info.shifts.night.overtime }}{% endif %}"{% if date_info.shifts.night.overtime %} data-has-db-value="true"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}"/>
    {% endif %}
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>

<!-- è¨ˆç”»åœæ­¢ -->
<tr data-section="stop_time" data-shift="day">
  <th class="category-label" rowspan="2" style="cursor:move;">
    è¨ˆç”»åœæ­¢
  </th>

  <!-- æ—¥å‹¤ -->
  <th class="shift-label" colspan="2">æ—¥å‹¤</th>
  {% for date_info in line_data.dates_data %}
  <td{% if date_info.is_weekend %} class="weekend"{% endif %} data-shift="day" data-date-index="{{ forloop.counter0 }}">
    <input class="stop-time-input" data-line-index="{{ line_index }}" max="480" min="0" step="5" type="number" value="{{ date_info.shifts.day.stop_time }}" data-shift="day" data-date-index="{{ forloop.counter0 }}"/>
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>

<!-- å¤œå‹¤ -->
<tr class="night-shift" data-section="stop_time" data-shift="night">
  <th class="shift-label" colspan="2">å¤œå‹¤</th>
  {% for date_info in line_data.dates_data %}
  <td{% if date_info.is_weekend %} class="weekend"{% endif %} data-shift="night" data-date-index="{{ forloop.counter0 }}">
    {% if not date_info.is_weekend %}
    <input class="stop-time-input" data-line-index="{{ line_index }}" max="480" min="0" step="5" type="number" value="{{ date_info.shifts.night.stop_time }}" data-shift="night" data-date-index="{{ forloop.counter0 }}"/>
    {% endif %}
  </td>
  {% endfor %}
  <td class="monthly-total"></td>
</tr>
</tbody>
</table>
{% endwith %}
{% endfor %}
</div>
</div>

{% include 'components/toast.html' %}

<!-- CSRFãƒˆãƒ¼ã‚¯ãƒ³ -->
{% csrf_token %}

<!-- ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã«æ¸¡ã™ -->
<script>
    // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®å“ç•ªãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚¯ãƒˆã€è‰¯å“ç‡ï¼‰ã®é…åˆ—
    linesItemData = [
        {% for line_data in lines_data %}
        {{ line_data.item_data|safe }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    // å‰æœˆæœ«ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿
    previousMonthStocks = {{ previous_month_stocks_json|safe }};
    // ãƒ†ãƒ¼ãƒ–ãƒ«æ•°
    const LINE_COUNT = {{ lines_data|length }};
</script>

<!-- å¤–éƒ¨JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
<script src="{% static 'js/vendor/jquery/jquery-3.7.1.min.js' %}"></script>
<script src="{% static 'js/vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/vendor/select2/select2.min.js' %}"></script>
<script src="{% static 'js/toast.js' %}"></script>
<script src="{% static 'js/machining_production_plan.js' %}"></script>

<script>
// Excelå‡ºåŠ›é–¢æ•°
function exportToExcel() {
    const targetMonthInput = document.getElementById('target-month');
    if (!targetMonthInput || !targetMonthInput.value) {
        alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    const [year, month] = targetMonthInput.value.split('-');
    const url = `/management_room/production-plan/excel-export/?year=${year}&month=${month}`;

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    window.location.href = url;
}

// é‹³é€ ç”Ÿç”£è¨ˆç”»ã¸é·ç§»
function goToCastingPlan() {
    const targetMonthInput = document.getElementById('target-month');
    if (!targetMonthInput || !targetMonthInput.value) {
        window.location.href = '{% url "management_room:casting_production_plan" %}';
        return;
    }

    const [year, month] = targetMonthInput.value.split('-');
    const url = `{% url "management_room:casting_production_plan" %}?year=${year}&month=${month}`;
    window.location.href = url;
}
</script>
</body>
</html>
