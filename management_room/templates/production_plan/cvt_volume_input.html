{% extends 'base.html' %}

{% block title %}CVT生産数量入力{% endblock %}

{% block content %}
<h1>CVT生産数量入力</h1>

<form id="production-form" method="post">
  {% csrf_token %}
  <input type="hidden" name="target_month" id="target-month-hidden" value="{{ year }}-{{ month|stringformat:'02d' }}">
  <input type="hidden" name="production_data" id="production-data-hidden">

  <div style="display: flex; flex-direction: column; gap: 1em; margin-bottom: 1em;">
    <div class="input-container" style="display: flex; align-items: center; gap: 0.5em;">
      <label for="target-month">対象月：</label>
      <input class="form-control" type="month" id="target-month" style="width: 200px;" value="{{ year }}-{{ month|stringformat:'02d' }}">
    </div>
  </div>

  <table id="plan-table" class="table" style="width:100%; border-collapse:collapse; margin-top:1em;">
    <thead>
      <tr>
        <th style="border-bottom:1px solid; padding:0.5em;">車種</th>
        <th style="border-bottom:1px solid; padding:0.5em;">ライン</th>
        <th style="border-bottom:1px solid; padding:0.5em;">予定数量</th>
      </tr>
    </thead>
    <tbody>
      {% for item in item_list %}
      <tr class="item-row"
          data-item-name="{{ item.name }}"
          data-line-id="{{ item.line_id }}"
          data-line-name="{{ item.line_name }}">
        <td style="border-bottom:1px solid; padding:0.5em;">
          {{ item.name }}
        </td>
        <td style="border-bottom:1px solid; padding:0.5em;">
          {{ item.line_name }}
        </td>
        <td style="border-bottom:1px solid; padding:0.5em;">
          <input type="number" class="form-control planned-volume"
                 name="planned_volume_{{ item.name }}"
                 min="0"
                 style="width:120px;"
                 data-item-name="{{ item.name }}"
                 {% if item.planned_volume %}value="{{ item.planned_volume }}"{% endif %}>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="margin-top:1em;">
    <button class="btn btn-primary" type="submit">登録</button>
  </div>
</form>

<script>
(function() {
  'use strict';

  // ========================================
  // 定数
  // ========================================
  const SELECTORS = {
    FORM: '#production-form',
    TARGET_MONTH_INPUT: '#target-month',
    TARGET_MONTH_HIDDEN: '#target-month-hidden',
    PRODUCTION_DATA_HIDDEN: '#production-data-hidden',
    ITEM_ROW: '.item-row',
    PLANNED_VOLUME: '.planned-volume'
  };

  const AJAX_HEADER = 'XMLHttpRequest';

  // ========================================
  // ユーティリティ関数
  // ========================================

  /**
   * 要素を取得（存在しない場合はエラー）
   * @param {string} selector - セレクター
   * @returns {HTMLElement}
   */
  function getElement(selector) {
    const element = document.querySelector(selector);
    if (!element) {
      throw new Error(`要素が見つかりません: ${selector}`);
    }
    return element;
  }

  /**
   * すべての要素を取得
   * @param {string} selector - セレクター
   * @returns {NodeList}
   */
  function getAllElements(selector) {
    return document.querySelectorAll(selector);
  }

  // ========================================
  // データ操作関数
  // ========================================

  /**
   * すべての予定数量入力欄をクリア
   */
  function clearAllPlannedVolumes() {
    getAllElements(SELECTORS.PLANNED_VOLUME).forEach(input => {
      input.value = '';
    });
  }

  /**
   * 行に予定数量を設定
   * @param {HTMLElement} row - 行要素
   * @param {Object} data - データオブジェクト
   */
  function setPlannedVolumeForRow(row, data) {
    const itemName = row.dataset.itemName;

    if (data[itemName]) {
      const plannedVolumeInput = row.querySelector(SELECTORS.PLANNED_VOLUME);
      if (plannedVolumeInput) {
        plannedVolumeInput.value = data[itemName];
      }
    }
  }

  /**
   * すべての行に予定数量を設定
   * @param {Object} data - データオブジェクト
   */
  function setAllPlannedVolumes(data) {
    getAllElements(SELECTORS.ITEM_ROW).forEach(row => {
      setPlannedVolumeForRow(row, data);
    });
  }

  /**
   * 行から生産データを抽出
   * @param {HTMLElement} row - 行要素
   * @returns {Object|null} - 生産データ（数量が0の場合はnull）
   */
  function extractProductionDataFromRow(row) {
    const itemName = row.dataset.itemName;
    const lineId = row.dataset.lineId;
    const lineName = row.dataset.lineName;
    const quantityInput = row.querySelector(SELECTORS.PLANNED_VOLUME);
    const quantity = parseInt(quantityInput?.value) || 0;

    if (quantity <= 0) {
      return null;
    }

    return {
      item_name: itemName,
      line_name: lineName,
      line_id: lineId,
      quantity: quantity
    };
  }

  /**
   * すべての行から生産データを収集
   * @returns {Array} - 生産データの配列
   */
  function collectAllProductionData() {
    const productionData = [];

    getAllElements(SELECTORS.ITEM_ROW).forEach(row => {
      const data = extractProductionDataFromRow(row);
      if (data) {
        productionData.push(data);
      }
    });

    return productionData;
  }

  // ========================================
  // API通信関数
  // ========================================

  /**
   * 指定月のデータを取得
   * @param {string} month - 対象月（YYYY-MM形式）
   * @returns {Promise<Object>}
   */
  async function fetchMonthData(month) {
    try {
      const response = await fetch(`?month=${month}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': AJAX_HEADER
        }
      });

      if (!response.ok) {
        throw new Error(`HTTPエラー: ${response.status}`);
      }

      const result = await response.json();
      return result.data;
    } catch (error) {
      console.error('データ取得エラー:', error);
      alert('データの取得に失敗しました。ページを再読み込みしてください。');
      throw error;
    }
  }

  /**
   * 月切り替え時にデータを読み込む
   * @param {string} month - 対象月（YYYY-MM形式）
   */
  async function loadMonthData(month) {
    try {
      const data = await fetchMonthData(month);

      // 全ての入力をクリア
      clearAllPlannedVolumes();

      // データを設定
      setAllPlannedVolumes(data);
    } catch (error) {
      // エラーは fetchMonthData 内で処理済み
    }
  }

  // ========================================
  // イベントハンドラー
  // ========================================

  /**
   * 対象月変更時の処理
   * @param {Event} event - イベント
   */
  function handleMonthChange(event) {
    const newMonth = event.target.value;

    // 隠しフィールドを更新
    const hiddenInput = getElement(SELECTORS.TARGET_MONTH_HIDDEN);
    hiddenInput.value = newMonth;

    // 選択した月のデータを取得
    loadMonthData(newMonth);
  }

  /**
   * フォーム送信時の処理
   * @param {Event} event - イベント
   */
  function handleFormSubmit(event) {
    // データを収集
    const productionData = collectAllProductionData();

    // JSON文字列に変換して隠しフィールドにセット
    const hiddenInput = getElement(SELECTORS.PRODUCTION_DATA_HIDDEN);
    hiddenInput.value = JSON.stringify(productionData);

    // データが空の場合は警告
    if (productionData.length === 0) {
      if (!confirm('登録するデータがありません。このまま送信しますか？')) {
        event.preventDefault();
      }
    }
  }

  // ========================================
  // 初期化
  // ========================================

  /**
   * イベントリスナーを登録
   */
  function initializeEventListeners() {
    // 対象月の変更イベント
    const targetMonthInput = getElement(SELECTORS.TARGET_MONTH_INPUT);
    targetMonthInput.addEventListener('change', handleMonthChange);

    // フォーム送信イベント
    const form = getElement(SELECTORS.FORM);
    form.addEventListener('submit', handleFormSubmit);
  }

  /**
   * アプリケーション初期化
   */
  function initialize() {
    try {
      initializeEventListeners();
    } catch (error) {
      console.error('初期化エラー:', error);
      alert('ページの初期化に失敗しました。ページを再読み込みしてください。');
    }
  }

  // DOMContentLoaded イベントで初期化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }
})();
</script>

{% endblock %}
