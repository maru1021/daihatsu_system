# コンロッドライン特別処理

## 概要

コンロッドラインは、外注生産があるため通常のラインとは異なる特別な処理が必要。

## 特別な処理内容

### 1. 出庫数の3倍換算

**理由**: 外注分を考慮するため

**実装場所**:
- `management_room/views/production_plan/machining_production_plan.py:187-189`

```python
# コンロッドラインの場合、出庫数を3倍にする
if line_name == 'コンロッド' and allocated_qty is not None:
    allocated_qty = allocated_qty * 3
```

### 2. 生産数の初期値計算ロジック

**通常ライン**: 出庫数 = 生産数（初期値）

**コンロッドライン**:
1. 出庫数（3倍済み）から各品番の比率を算出
2. (定時間+残業時間) / タクト × 稼働率 で生産可能台数を算出
3. 生産可能台数を比率で配分して各品番の生産数を設定

**実装場所**:
- `static/js/machining_production_plan.js:355-446` (`calculateConrodProductionByRatio`)
- `static/js/machining_production_plan.js:1785-1801` (初期化処理)

### 3. ヘッドラインデータの参照

コンロッドラインにデータがない場合、ヘッドラインの以下のデータを取得：
- 残業時間
- 計画停止時間
- 定時・休出情報

**注意**: 稼働率はコンロッドライン自身のものを使用

**実装場所**:
- `management_room/views/production_plan/machining_production_plan.py:122-149`
- `management_room/views/production_plan/machining_production_plan.py:214-231`

## 計算例

### シナリオ
- 組付けからの出庫要求: KF 179個、DNGA 113個
- ヘッドラインの残業時間: 60分
- コンロッドのタクト: 0.217分/個
- コンロッドの稼働率: 95%

### 計算プロセス

**ステップ1: 出庫数を3倍**
- KF: 179 × 3 = 537個
- DNGA: 113 × 3 = 339個

**ステップ2: 比率を算出**
- 合計: 537 + 339 = 876個
- KF比率: 537 / 876 = 61.3%
- DNGA比率: 339 / 876 = 38.7%

**ステップ3: 生産可能台数を算出**
- 定時間: 455分（日勤の場合）
- 残業時間: 60分
- 総生産時間: 455 + 60 = 515分
- 生産可能台数: 515 / 0.217 × 0.95 = 2,252台

**ステップ4: 比率で配分**
- KF: 2,252 × 61.3% = 1,380台
- DNGA: 2,252 × 38.7% = 872台

## コード構造

### サーバーサイド (Python)

```
machining_production_plan.py
├── get() メソッド
│   ├── 出庫数を3倍に変換 (187-189行)
│   └── ヘッドラインデータ取得 (122-149行)
│       ├── 残業時間
│       ├── 計画停止
│       └── 定時・休出フラグ
└── シフトデータ設定 (214-231行)
```

### フロントエンド (JavaScript)

```
machining_production_plan.js
├── calculateConrodProductionByRatio() (355-446行)
│   ├── 出庫数から比率算出
│   ├── 生産可能台数計算
│   │   └── 残業上限適用（日勤120分、夜勤60分）
│   └── 比率配分
├── updateProductionQuantity() (459-494行)
│   └── コンロッドの場合は出庫数コピーをスキップ
└── performInitialCalculations() (1758-1809行)
    └── コンロッド専用初期計算実行
```

### HTML

```
machining_production_plan.html
└── <table> (80行)
    └── data-line-name="{{ line_name }}" 属性追加
```

## 残業時間の制限

初期割り振り時の残業時間制限（`calculateConrodProductionByRatio` 内で適用）:
- **土日（休出なし）**: 残業0分
- **土日（休出あり）**: 残業0分
- **日勤（定時チェックあり）**: 残業0分
- **通常時（日勤）**: 最大120分
- **通常時（夜勤）**: 最大60分

## 注意事項

1. **DBにデータがある場合**: 保存された値を優先し、特別な計算は行わない
2. **出庫数が0の場合**: 生産数も0として扱う
3. **稼働率**: 常にコンロッドライン自身の値を使用（ヘッドラインからコピーしない）
4. **比率の保存**: 計算後の生産数から比率を保存し、以降の再計算で使用
