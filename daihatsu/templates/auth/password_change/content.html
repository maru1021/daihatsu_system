<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8 password-change-form">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>
                        パスワード変更
                    </h4>
                </div>
                <div class="card-body">
                    <form id="passwordChangeForm">
                        <!-- メッセージ表示エリア -->
                        <div id="form-messages" class="mb-3"></div>

                        <!-- 現在のパスワード -->
                        <div class="mb-3">
                            <label for="id_old_password" class="form-label">
                                <i class="fas fa-lock me-1"></i>
                                現在のパスワード
                                <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="id_old_password" name="old_password" autofocus>
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- 新しいパスワード -->
                        <div class="mb-3">
                            <label for="id_new_password1" class="form-label">
                                <i class="fas fa-key me-1"></i>
                                新しいパスワード
                                <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="id_new_password1" name="new_password1">
                            <div class="invalid-feedback"></div>
                            <div class="form-text">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    パスワードは8文字以上で、数字のみは使用できません。
                                </small>
                            </div>
                        </div>

                        <!-- 新しいパスワード（確認） -->
                        <div class="mb-4">
                            <label for="id_new_password2" class="form-label">
                                <i class="fas fa-check-double me-1"></i>
                                新しいパスワード（確認）
                                <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="id_new_password2" name="new_password2">
                            <div class="invalid-feedback"></div>
                        </div>

                        <!-- ボタン群 -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary submit-button">
                                <i class="fas fa-save me-2"></i>
                                パスワードを変更
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                キャンセル
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- パスワード要件の説明 -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-shield-alt me-2 text-info"></i>
                        パスワード要件
                    </h6>
                    <ul class="mb-0 small text-muted">
                        <li>8文字以上である必要があります</li>
                        <li>数字のみのパスワードは使用できません</li>
                        <li>一般的すぎるパスワードは使用できません</li>
                        <li>個人情報と類似したパスワードは避けてください</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
window.passwordChangeFormLoad = false;

function initializePasswordChangeForm() {
    if (window.passwordChangeFormLoad) return;

    if (typeof $ === 'undefined' || !$('#passwordChangeForm').length) {
        setTimeout(initializePasswordChangeForm, 50);
        return;
    }

    // フォーム送信処理
    $('#passwordChangeForm').on('submit', function(e) {
        e.preventDefault();

        const form = this;
        const url = "{% url 'password_change' %}";
        const $messages = $('#form-messages');

        // フロントエンドバリデーション実行
        if (!validatePasswordChangeForm()) {
            return;
        }

        // バリデーション成功時のみ送信
        submitForm(form, url, function(data) {
            if (data.status === 'success') {
                showSuccessMessage($messages, data.message);
                resetPasswordForm();
            } else if (data.status === 'error') {
                // サーバーサイドバリデーションエラー
                showErrorMessage($messages, data);
            }
        }, false).catch(function(error) {
            if (error.response && error.data) {
                showErrorMessage($messages, error.data);
            } else {
                showSystemError($messages);
            }
        });
    });

    window.passwordChangeFormLoad = true;
}

function validatePasswordChangeForm() {
    let isValid = true;

    // 全フィールドからis-invalidクラスを削除
    $('#passwordChangeForm .form-control').removeClass('is-invalid');

    // 現在のパスワードのバリデーション
    const oldPassword = $('#id_old_password').val().trim();
    const oldPasswordField = $('#id_old_password');
    const oldPasswordFeedback = oldPasswordField.next('.invalid-feedback');

    if (!oldPassword) {
        oldPasswordField.addClass('is-invalid');
        oldPasswordFeedback.text('現在のパスワードは必須です。');
        isValid = false;
    }

    // 新しいパスワードのバリデーション
    const newPassword1 = $('#id_new_password1').val().trim();
    const newPassword1Field = $('#id_new_password1');
    const newPassword1Feedback = newPassword1Field.next('.invalid-feedback');

    if (!newPassword1) {
        newPassword1Field.addClass('is-invalid');
        newPassword1Feedback.text('新しいパスワードは必須です。');
        isValid = false;
    } else {
        // パスワード強度チェック
        const strengthErrors = validatePasswordStrength(newPassword1);
        if (strengthErrors.length > 0) {
            newPassword1Field.addClass('is-invalid');
            newPassword1Feedback.text(strengthErrors[0]);
            isValid = false;
        }
    }

    // パスワード確認のバリデーション
    const newPassword2 = $('#id_new_password2').val().trim();
    const newPassword2Field = $('#id_new_password2');
    const newPassword2Feedback = newPassword2Field.next('.invalid-feedback');

    if (!newPassword2) {
        newPassword2Field.addClass('is-invalid');
        newPassword2Feedback.text('パスワード確認は必須です。');
        isValid = false;
    } else if (newPassword1 && newPassword1 !== newPassword2) {
        newPassword2Field.addClass('is-invalid');
        newPassword2Feedback.text('新しいパスワードが一致しません。');
        isValid = false;
    }

    return isValid;
}

function validatePasswordStrength(password) {
    const errors = [];

    if (password.length < 8) {
        errors.push('パスワードは8文字以上である必要があります。');
    }

    if (password && password.match(/^\d+$/)) {
        errors.push('パスワードは数字のみでは設定できません。');
    }

    const commonPasswords = ['password', '12345678', '123456789', 'qwerty', 'abc123'];
    if (commonPasswords.includes(password.toLowerCase())) {
        errors.push('このパスワードは一般的すぎます。別のパスワードを選択してください。');
    }

    return errors;
}

function showSuccessMessage($container, message) {
    $container.html(`
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
}

function showErrorMessage($container, response) {
    // サーバーサイドバリデーションエラーの場合、フィールドにis-invalidクラスを設定
    if (response.error_details && Array.isArray(response.error_details)) {
        // 全フィールドからis-invalidクラスを削除
        $('#passwordChangeForm .form-control').removeClass('is-invalid');

        response.error_details.forEach(function(errorMsg) {
            if (errorMsg.includes('現在のパスワード:')) {
                const field = $('#id_old_password');
                const feedback = field.next('.invalid-feedback');
                field.addClass('is-invalid');
                feedback.text(errorMsg.replace('現在のパスワード: ', ''));
            } else if (errorMsg.includes('新しいパスワード:')) {
                const field = $('#id_new_password1');
                const feedback = field.next('.invalid-feedback');
                field.addClass('is-invalid');
                feedback.text(errorMsg.replace('新しいパスワード: ', ''));
            } else if (errorMsg.includes('パスワード確認:')) {
                const field = $('#id_new_password2');
                const feedback = field.next('.invalid-feedback');
                field.addClass('is-invalid');
                feedback.text(errorMsg.replace('パスワード確認: ', ''));
            }
        });
    }

    let errorDetails = '';
    if (response.error_details?.length > 0) {
        errorDetails = '<ul class="mb-0 mt-2">' +
                      response.error_details.map(error => `<li><small>${error}</small></li>`).join('') +
                      '</ul>';
    }

    $container.html(`
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${response.message || 'エラーが発生しました。'}
            ${errorDetails}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
}

function showSystemError($container) {
    $container.html(`
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            システムエラーが発生しました。管理者にお問い合わせください。
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
}

function resetPasswordForm() {
    $('#passwordChangeForm')[0].reset();
}

// リアルタイムバリデーション設定
function setupRealtimeValidation() {
    if (typeof $ === 'undefined') {
        setTimeout(setupRealtimeValidation, 50);
        return;
    }

    // 入力時にバリデーションエラーをクリア
    $('#id_old_password, #id_new_password1, #id_new_password2').on('input', function() {
        $(this).removeClass('is-invalid');
    });
}

// 初期化処理
function initPasswordChange() {
    if (typeof $ === 'undefined') {
        setTimeout(initPasswordChange, 50);
        return;
    }

    if (!window.passwordChangeFormLoad) {
        initializePasswordChangeForm();
    }

    setupRealtimeValidation();
}

// DOM読み込み完了時または即座に実行
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPasswordChange);
} else {
    initPasswordChange();
}
</script>

<style>
.password-change-form {
    .form-control { border-radius: 8px; }
    .btn { border-radius: 8px; }
    .card { border-radius: 12px; }
    .card-header { border-radius: 12px 12px 0 0 !important; }
    .alert { border-radius: 8px; }
    .form-label i { color: #6c757d; }
}
</style>
