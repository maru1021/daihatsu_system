function initializeTableMasterPage(){const pageId=window.location.pathname+'_tableMaster';if(window.initializationFlags[pageId]){return;}
window.initializationFlags[pageId]=true;const registerForm=$('#RegisterForm');registerForm.off('submit.tableMaster').on('submit.tableMaster',function(e){e.preventDefault();const createUrl=registerForm.attr('action');submitForm(registerForm,createUrl,(data)=>{hideModal('RegisterModal');showToast('success',data.message);if(data.html){$('#TableContainer').html(data.html);initializePaginationEvents();}}).catch(error=>{handleFormError(error,registerForm);});});initializeSearchEvents();initializePaginationEvents();initializeTableEvents();search_date();}
function initializeSearchEvents(){const searchInput=$('input[name="search"]');searchInput.off('input.tableSearch').on('input.tableSearch',debounce(function(event){const searchUrl=searchInput.attr('data-search-url');const searchQuery=event.target.value||'';if(!searchUrl){return;}
searchTableData(searchUrl,searchQuery).then(()=>{initializePaginationEvents();}).catch(error=>{console.error('Error:',error);showToast('error',error.message||'検索に失敗しました。');});},100));}
function search_date(){const $input=$('input[name="search_date"]');$input.on('change',function(){const date_val=this.value;if(!date_val)return;let base=(window.base_url||'')+(window.search_date_url||'');base=base.replace(/\/?$/,'/');const url=base+encodeURIComponent(date_val)+'/';if(window.htmx){htmx.ajax('GET',url,{target:'.main-content',pushUrl:true,swap:'innerHTML'});}else{window.location.href=url;}});}
function initializePaginationEvents(){$('.pagination a').off('click.pagination').on('click.pagination',function(e){e.preventDefault();const url=this.href;if($(this).data('loading'))return;$(this).data('loading',true);window.history.pushState({},'',url);fetch(url,{headers:{'HX-Request':'true'}}).then(response=>response.text()).then(html=>{$('#TableContainer').html(html);initializePaginationEvents();}).catch(error=>{console.error('Error:',error);showToast('error','ページの読み込みに失敗しました。');}).finally(()=>{$(this).removeData('loading');});});}
function initializeTableEvents(){if(window.tableEventsInitialized){return;}
window.tableEventsInitialized=true;$(document).on('click.tableEvents','.edit-item',function(e){handleEditItem(e,$(this));});$(document).on('click.tableEvents','.delete-item',function(e){handleDeleteItem(e,$(this));});}
function handleEditItem(e,editBtn){e.preventDefault();e.stopPropagation();const editUrl=editBtn.attr('data-edit-url');fetch(editUrl).then(response=>response.json()).then(data=>{if(data.status==='success'){window.currentEditData=data.data;const editModal=$('#EditModal');const form=editModal.find('form');if(form){form.action=editUrl;editModal.off('shown.bs.modal.editForm').on('shown.bs.modal.editForm',function(){initializeEditForm(data);});}
showModal('EditModal');if(form){form.off('submit.editForm').on('submit.editForm',function(e){handleEditFormSubmit(e,form);});}}else{showToast('error','アイテムの情報を取得できませんでした。');}}).catch(error=>{showToast('error','アイテムの情報を取得できませんでした。');});}
function handleEditFormSubmit(e,editForm){e.preventDefault();const invalidFeedbacks=editForm.find('.invalid-feedback');invalidFeedbacks.remove();const invalidInputs=editForm.find('.is-invalid');invalidInputs.removeClass('is-invalid');submitForm(editForm,editForm.attr('action'),(data)=>{hideModal('EditModal');showToast('success',data.message);if(data.html){$('#TableContainer').html(data.html);initializePaginationEvents();}}).catch(error=>{handleFormError(error,editForm);});}
function handleDeleteItem(e,deleteBtn){e.preventDefault();e.stopPropagation();if(deleteBtn.closest('.improvement-schedule-container').length>0){return;}
const itemName=deleteBtn.attr('data-item-name');const deleteUrl=deleteBtn.attr('data-delete-url');showModal('DeleteModal');updateModalMessage(`本当に「${itemName}」を削除してもよろしいですか？`);const confirmBtn=$('#DeleteModal').find('#confirmDeleteBtn');if(confirmBtn.length){confirmBtn.off('click.deleteConfirm').on('click.deleteConfirm',function(){performDelete(deleteUrl,(data)=>{hideModal('DeleteModal');showToast('success',data.message);if(data.html){$('#TableContainer').html(data.html);initializePaginationEvents();}}).catch(error=>{console.error('Error:',error);showToast('error',error.message||'削除に失敗しました。');});});}}
window.handleTableDeleteItem=handleDeleteItem;;