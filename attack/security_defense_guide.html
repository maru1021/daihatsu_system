<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é˜²å¾¡ã‚¬ã‚¤ãƒ‰ - SSHãƒ»Webæ”»æ’ƒå¯¾ç­–</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1976d2;
            border-bottom: 3px solid #1976d2;
            padding-bottom: 10px;
        }
        h2 {
            color: #388e3c;
            margin-top: 30px;
            border-left: 5px solid #388e3c;
            padding-left: 15px;
        }
        h3 {
            color: #f57c00;
            margin-top: 25px;
        }
        h4 {
            color: #5d4037;
            margin-top: 20px;
        }
        .alert {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .danger {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .command {
            background-color: #263238;
            color: #4caf50;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
            border-left: 5px solid #4caf50;
        }
        .config {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
            border-left: 5px solid #2196f3;
        }
        .check {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .port {
            font-family: monospace;
            background-color: #f8f8f8;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        .ip {
            font-family: monospace;
            background-color: #fff8e1;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .step {
            counter-increment: step-counter;
            margin: 20px 0;
            padding: 15px;
            border-left: 5px solid #ff9800;
            background-color: #fff3e0;
        }
        .step::before {
            content: "ã‚¹ãƒ†ãƒƒãƒ— " counter(step-counter) ": ";
            font-weight: bold;
            color: #e65100;
        }
        .step-container {
            counter-reset: step-counter;
        }
        .toc {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .toc ul {
            margin: 0;
            padding-left: 20px;
        }
        .toc li {
            margin: 5px 0;
        }
        .toc a {
            text-decoration: none;
            color: #007bff;
        }
        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é˜²å¾¡ã‚¬ã‚¤ãƒ‰</h1>

        <div class="success">
            <strong>ç›®çš„:</strong> ã‚µãƒ¼ãƒãƒ¼ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç·åˆçš„ã«å¼·åŒ–ã—ã€SSHæ”»æ’ƒãƒ»Webæ”»æ’ƒãƒ»APTæ”»æ’ƒã‹ã‚‰é˜²å¾¡ã™ã‚‹ãŸã‚ã®å®Ÿè·µçš„ãªã‚¬ã‚¤ãƒ‰ã§ã™ã€‚
        </div>

        <div class="toc">
            <h3>ğŸ“‹ ç›®æ¬¡</h3>
            <ul>
                <li><a href="#ssh-security">1. SSH ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–</a></li>
                <li><a href="#firewall-setup">2. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š</a></li>
                <li><a href="#web-security">3. Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¿è­·</a></li>
                <li><a href="#django-security">4. Django ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</a></li>
                <li><a href="#database-security">5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</a></li>
                <li><a href="#django-advanced">6. Django é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</a></li>
                <li><a href="#threat-modeling">7. æ–°ã—ã„è„…å¨ã¨å¯¾å‡¦æ³•</a></li>
                <li><a href="#advanced-security">8. é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</a></li>
                <li><a href="#django-monitoring">9. Django ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–</a></li>
                <li><a href="#daihatsu-vulnerabilities">ğŸš¨ 10. daihatsuãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è„†å¼±æ€§å¯¾ç­–</a></li>
                <li><a href="#incident-response-advanced">11. é«˜åº¦ãªã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ</a></li>
                <li><a href="#monitoring">12. ç¶™ç¶šç›£è¦–ã¨ãƒ­ã‚°åˆ†æ</a></li>
                <li><a href="#incident-response">13. ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †</a></li>
                <li><a href="#verification">14. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰</a></li>
            </ul>
        </div>

        <section id="ssh-security">
            <h2>ğŸ” 1. SSH ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–</h2>

            <h3>1.1 SSHæ¥ç¶šã®ç›£è¦–</h3>
            <div class="check">
                <h4>ç¾åœ¨ã®æ¥ç¶šç¢ºèª</h4>
                <div class="command">
                    <div># ç¾åœ¨ã®SSHæ¥ç¶šä¸€è¦§</div>
                    <div>netstat -tn | grep :22</div>

                    <div># ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
                    <div>who</div>
                    <div>w</div>

                    <div># SSHæ¥ç¶šå±¥æ­´</div>
                    <div>last | head -10</div>
                </div>
            </div>

            <h3>1.2 SSHæ”»æ’ƒãƒ­ã‚°ã®åˆ†æ</h3>
            <div class="command">
                <div># SSHèªè¨¼å¤±æ•—ã®ç¢ºèª</div>
                <div>sudo grep "Failed password" /var/log/auth.log | tail -10</div>

                <div># ç„¡åŠ¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®æ”»æ’ƒè©¦è¡Œ</div>
                <div>sudo grep "Invalid user" /var/log/auth.log | tail -10</div>

                <div># å…¬é–‹éµèªè¨¼ã®æˆåŠŸãƒ­ã‚°</div>
                <div>sudo grep "Accepted publickey" /var/log/auth.log | tail -10</div>

                <div># èªè¨¼è©¦è¡Œéå¤šã§ã®åˆ‡æ–­</div>
                <div>sudo grep "Too many authentication failures" /var/log/auth.log | tail -5</div>
            </div>

            <div class="step-container">
                <div class="step">
                    <strong>SSHéµæ¼æ´©ã®ç¢ºèª</strong>
                    <div class="command">
                        <div># åŒä¸€éµãƒãƒƒã‚·ãƒ¥ã§ã®è¤‡æ•°IPæ¥ç¶šç¢ºèª</div>
                        <div>sudo grep "SHA256:" /var/log/auth.log | grep "Accepted publickey" | awk '{print $9, $11}' | sort | uniq -c</div>
                    </div>
                </div>

                <div class="step">
                    <strong>SSHå®Œå…¨ç„¡åŠ¹åŒ–ï¼ˆç·Šæ€¥æ™‚ï¼‰</strong>
                    <div class="command">
                        <div># SSHè‡ªå‹•èµ·å‹•ç„¡åŠ¹åŒ–</div>
                        <div>sudo systemctl disable ssh</div>

                        <div># SSHã‚µãƒ¼ãƒ“ã‚¹åœæ­¢</div>
                        <div>sudo systemctl stop ssh</div>

                        <div># å†èµ·å‹•é˜²æ­¢ï¼ˆãƒã‚¹ã‚¯ï¼‰</div>
                        <div>sudo systemctl mask ssh</div>

                        <div># SSHéµç„¡åŠ¹åŒ–</div>
                        <div>sudo mv ~/.ssh/authorized_keys ~/.ssh/authorized_keys.backup</div>
                    </div>
                </div>

                <div class="step">
                    <strong>SSHè¨­å®šå¼·åŒ–</strong>
                    <div class="command">
                        <div># /etc/ssh/sshd_config ã®æ¨å¥¨è¨­å®š</div>

                        <div># ãƒãƒ¼ãƒˆå¤‰æ›´ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®22ã‹ã‚‰å¤‰æ›´ï¼‰</div>
                        <div>Port 2222</div>

                        <div># ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç„¡åŠ¹åŒ–</div>
                        <div>PasswordAuthentication no</div>

                        <div># rootç›´æ¥ãƒ­ã‚°ã‚¤ãƒ³ç¦æ­¢</div>
                        <div>PermitRootLogin no</div>

                        <div># èªè¨¼è©¦è¡Œå›æ•°åˆ¶é™</div>
                        <div>MaxAuthTries 3</div>

                        <div># ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¨±å¯</div>
                        <div>AllowUsers specific_user</div>

                        <div># X11ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç„¡åŠ¹</div>
                        <div>X11Forwarding no</div>
                    </div>
                </div>
            </div>

            <h3>1.3 æ–°ã—ã„SSHéµã®ç”Ÿæˆ</h3>
            <div class="command">
                <div># ED25519éµç”Ÿæˆï¼ˆæ¨å¥¨ï¼‰</div>
                <div>ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519_new -C "your_email@example.com"</div>

                <div># ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºä»˜ãã§ç”Ÿæˆ</div>
                <div>ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519_secure</div>

                <div># å…¬é–‹éµã®ã‚µãƒ¼ãƒãƒ¼ç™»éŒ²</div>
                <div>cat ~/.ssh/id_ed25519_new.pub >> ~/.ssh/authorized_keys</div>

                <div># é©åˆ‡ãªæ¨©é™è¨­å®š</div>
                <div>chmod 600 ~/.ssh/authorized_keys</div>
                <div>chmod 700 ~/.ssh</div>

                <div># ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºè¨­å®š</div>
                <div>ssh-keygen -p -f ~/.ssh/id_ed25519_secure</div>
            </div>
        </section>

        <section id="firewall-setup">
            <h2>ğŸ”¥ 2. ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š</h2>

            <h3>2.1 ç¾åœ¨ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ç¢ºèª</h3>
            <div class="command">
                <div># é–‹ã„ã¦ã„ã‚‹ãƒãƒ¼ãƒˆä¸€è¦§</div>
                <div>sudo netstat -tulpn</div>

                <div># ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ¥ç¶š</div>
                <div>sudo ss -tulpn</div>

                <div># iptablesç¾åœ¨ã®ãƒ«ãƒ¼ãƒ«</div>
                <div>sudo iptables -L -n --line-numbers</div>
            </div>

            <h3>2.2 å±é™ºãªãƒãƒ¼ãƒˆã®é®æ–­</h3>
            <div class="step-container">
                <div class="step">
                    <strong>PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿è­·</strong>
                    <div class="command">
                        <div># PostgreSQLå¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹é®æ–­</div>
                        <div>sudo iptables -I INPUT -p tcp --dport 5432 -s 127.0.0.1 -j ACCEPT</div>
                        <div>sudo iptables -I INPUT -p tcp --dport 5432 -j DROP</div>
                        <div></div>
                        <div># PostgreSQLè¨­å®šç¢ºèª</div>
                        <div>sudo -u postgres psql -c "SHOW hba_file;"</div>
                        <div>sudo systemctl status postgresql</div>
                    </div>
                </div>

                <div class="step">
                    <strong>Djangoé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ä¿è­·</strong>
                    <div class="command">
                        <div># æœ¬ç•ªç’°å¢ƒã§ã®DEBUGç„¡åŠ¹åŒ–ç¢ºèª</div>
                        <div>grep "DEBUG = False" daihatsu/settings.py</div>

                        <div># ä¸è¦ãªãƒãƒ¼ãƒˆã®é®æ–­</div>
                        <div>sudo netstat -tulpn | grep python</div>

                        <div># Djangoç®¡ç†ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™</div>
                        <div>sudo iptables -A INPUT -p tcp --dport 8000 -s 127.0.0.1 -j ACCEPT</div>
                        <div>sudo iptables -A INPUT -p tcp --dport 8000 -j DROP</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ä¸è¦ãªã‚µãƒ¼ãƒ“ã‚¹ãƒãƒ¼ãƒˆã®é®æ–­</strong>
                    <div class="command">
                        <div># é–‹ã„ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç¢ºèª</div>
                        <div>sudo netstat -tulpn | grep LISTEN</div>

                        <div># ä¸è¦ãªãƒãƒ¼ãƒˆé®æ–­ï¼ˆä¾‹ï¼š5432, 8080ãªã©ï¼‰</div>
                        <div>sudo iptables -I INPUT -p tcp --dport 5432 -j DROP</div>
                        <div>sudo iptables -I INPUT -p tcp --dport 8080 -j DROP</div>
                    </div>
                </div>
            </div>

            <h3>2.3 ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šã®æ°¸ç¶šåŒ–</h3>
            <div class="command">
                <div># iptablesè¨­å®šä¿å­˜</div>
                <div>sudo iptables-save > /etc/iptables/rules.v4</div>

                <div># èµ·å‹•æ™‚ã®è‡ªå‹•é©ç”¨è¨­å®š</div>
                <div>sudo apt install iptables-persistent</div>

                <div># è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°</div>
                <div>sudo netfilter-persistent save</div>
            </div>

            <h3>2.4 ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«æ¤œè¨¼</h3>
            <div class="check">
                <h4>ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</h4>
                <div class="command">
                    <div># æ­£å¸¸ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆé€šã‚‹ã¹ãï¼‰</div>
                    <div>curl -I https://maruomosquit.com/</div>
                    <div>curl -I https://maruomosquit.com/admin/</div>
                    <div></div>
                    <div># é®æ–­ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ã¹ãï¼‰</div>
                    <div>curl -I http://SERVER_IP:8000/ --connect-timeout 5</div>
                    <div>curl -I http://SERVER_IP:5432/ --connect-timeout 5</div>
                </div>
            </div>
        </section>

        <section id="web-security">
            <h2>ğŸŒ 3. Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¿è­·</h2>

            <h3>3.1 nginx ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h3>
            <div class="command">
                <div># nginx ãƒ—ãƒ­ã‚­ã‚·æ”»æ’ƒå¯¾ç­–è¨­å®š</div>

                <div>
                    <div>server {</div>
                    <div>listen 443 ssl;</div>
                    <div>server_name yourdomain.com www.yourdomain.com;</div>

                    <div># ãƒ—ãƒ­ã‚­ã‚·æ”»æ’ƒé˜²æ­¢</div>
                    <div>if ($request_uri ~ "^https?://") {</div>
                    <div>return 444;</div>
                    <div>}</div>

                    <div># ä¸æ­£ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦</div>
                    <div>if ($host !~ ^(maruomosquit\.com|www\.maruomosquit\.com)$) {</div>
                    <div>return 444;</div>
                    <div>}</div>

                    <div># ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼</div>
                    <div>add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;</div>
                    <div>add_header X-Content-Type-Options "nosniff" always;</div>
                    <div>add_header X-Frame-Options "DENY" always;</div>
                    <div>add_header X-XSS-Protection "1; mode=block" always;</div>
                    <div>server_tokens off;</div>

                    <div># SSLè¨­å®š</div>
                    <div>ssl_protocols TLSv1.2 TLSv1.3;</div>
                    <div>ssl_prefer_server_ciphers off;</div>

                    <div># ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ è¨­å®š</div>
                    <div>upstream django {</div>
                    <div>    server web:8000 max_fails=3 fail_timeout=30s;</div>
                    <div>    keepalive 64;</div>
                    <div>}</div>
                    <div></div>
                    <div># Djangoé™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡</div>
                    <div>location /static/ {</div>
                    <div>    alias /app/static/;</div>
                    <div>    expires 1m;</div>
                    <div>    add_header Cache-Control "public, max-age=3600";</div>
                    <div>    add_header X-Content-Type-Options nosniff;</div>
                    <div>    add_header X-Frame-Options DENY;</div>
                    <div>    add_header X-XSS-Protection "1; mode=block";</div>
                    <div>}</div>
                    <div></div>
                    <div>location /media/ {</div>
                    <div>    alias /app/media/;</div>
                    <div>    expires 1y;</div>
                    <div>    add_header Cache-Control "public, immutable";</div>
                    <div>    add_header X-Content-Type-Options nosniff;</div>
                    <div>}</div>
                    <div></div>
                    <div># Djangoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</div>
                    <div>location / {</div>
                    <div>    proxy_pass http://django;</div>
                    <div>    proxy_set_header Host $host;</div>
                    <div>    proxy_set_header X-Real-IP $remote_addr;</div>
                    <div>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div>
                    <div>    proxy_set_header X-Forwarded-Proto $scheme;</div>
                    <div>    proxy_redirect off;</div>
                    <div></div>
                    <div>    # ãƒ—ãƒ­ã‚­ã‚·ãƒãƒƒãƒ•ã‚¡è¨­å®š</div>
                    <div>    proxy_buffering on;</div>
                    <div>    proxy_buffer_size 4k;</div>
                    <div>    proxy_buffers 8 4k;</div>
                    <div>    proxy_busy_buffers_size 8k;</div>
                    <div></div>
                    <div>    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š</div>
                    <div>    proxy_connect_timeout 30s;</div>
                    <div>    proxy_send_timeout 30s;</div>
                    <div>    proxy_read_timeout 30s;</div>
                    <div>}</div>
                </div>

                <div># ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒãƒ¼ï¼ˆä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ï¼‰</div>
                <div>server {
                    <div>listen 80 default_server;</div>
                    <div>listen 443 ssl default_server;</div>
                    <div>server_name _;</div>

                    <div>ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;</div>
                    <div>ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;</div>

                    <div>return 444;</div>
                    <div>}</div>
                </div>
            </div>

            <h3>3.2 nginxè¨­å®šãƒ†ã‚¹ãƒˆã¨é©ç”¨</h3>
            <div class="command">
                <div># nginxè¨­å®šãƒ†ã‚¹ãƒˆ</div>
                <div>sudo nginx -t</div>

                <div># nginxè¨­å®šãƒªãƒ­ãƒ¼ãƒ‰</div>
                <div>sudo systemctl reload nginx</div>

                <div># nginxçŠ¶æ…‹ç¢ºèª</div>
                <div>sudo systemctl status nginx</div>
            </div>

            <h3>3.3 Webæ”»æ’ƒãƒ­ã‚°ã®ç›£è¦–</h3>
            <div class="command">
                <div># ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã®ä¸å¯©ãªãƒ‘ã‚¿ãƒ¼ãƒ³ç¢ºèª</div>
                <div>sudo tail -f /var/log/nginx/access.log | grep -E "CONNECT|POST.*http://"</div>

                <div># ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª</div>
                <div>sudo tail -20 /var/log/nginx/error.log</div>

                <div># ãƒ—ãƒ­ã‚­ã‚·æ”»æ’ƒã®æ¤œå‡º</div>
                <div>sudo grep -E "GET http://|CONNECT " /var/log/nginx/access.log | head -10</div>

                <div># ä¸å¯©ãªUser-Agentã®æ¤œå‡º</div>
                <div>sudo grep -i "bot\|scanner\|crawler" /var/log/nginx/access.log | head -10</div>
            </div>
        </section>


        <section id="monitoring">
            <h2>ğŸ‘ï¸ 12. ç¶™ç¶šç›£è¦–ã¨ãƒ­ã‚°åˆ†æ</h2>

            <h3>12.1 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚³ãƒãƒ³ãƒ‰</h3>
            <div class="command">
                <div># ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®ç›£è¦–</div>
                <div>watch -n 5 'netstat -tn'</div>

                <div># ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–</div>
                <div>watch -n 10 'ps aux --sort=-%cpu | head -20'</div>

                <div># ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç›£è¦–</div>
                <div>watch -n 30 'df -h'</div>

                <div># ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–</div>
                <div>watch -n 10 'free -m'</div>
            </div>

            <h3>12.2 ãƒ­ã‚°åˆ†æã®è‡ªå‹•åŒ–</h3>
            <div class="command">
                <div># SSHæ”»æ’ƒæ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ</div>
                <div>#!/bin/bash</div>
                <div># ä¸å¯©ãªSSHæ¥ç¶šã‚’æ¤œå‡º</div>
                <div>grep "$(date '+%b %d')" /var/log/auth.log | grep "Failed password\|Invalid user" | wc -l</div>

                <div># æ–°ã—ã„æ¥ç¶šã®ç¢ºèª</div>
                <div>tail -f /var/log/auth.log | grep --line-buffered "Accepted\|Failed"</div>

                <div># nginxæ”»æ’ƒæ¤œå‡º</div>
                <div>tail -f /var/log/nginx/access.log | grep --line-buffered -E "40[0-9]|50[0-9]"</div>
            </div>

            <h3>12.3 fail2banè¨­å®šï¼ˆè‡ªå‹•æ”»æ’ƒé®æ–­ï¼‰</h3>

            <h4>fail2banã¨ã¯</h4>
            <div class="check">
                <ul>
                    <li><strong>è‡ªå‹•æ”»æ’ƒæ¤œçŸ¥:</strong> ãƒ­ã‚°ã‚’ç›£è¦–ã—ã¦SSHæ”»æ’ƒã‚’æ¤œå‡º</li>
                    <li><strong>å³åº§é®æ–­:</strong> æ”»æ’ƒIPã‚’iptablesã§è‡ªå‹•ãƒ–ãƒ­ãƒƒã‚¯</li>
                    <li><strong>24æ™‚é–“ç›£è¦–:</strong> ç¶™ç¶šçš„ãªé˜²å¾¡ã‚’æä¾›</li>
                    <li><strong>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½:</strong> æ”»æ’ƒå›æ•°ã‚„é®æ–­æ™‚é–“ã‚’èª¿æ•´</li>
                </ul>
            </div>

            <div class="command">
                <div># fail2banã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                <div>sudo apt update</div>
                <div>sudo apt install fail2ban -y</div>

                <div># ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª</div>
                <div>sudo systemctl status fail2ban</div>
            </div>

            <h4>SSHä¿è­·è¨­å®š</h4>
            <div class="command">
                <div># SSHä¿è­·è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ</div>
                <div>sudo tee /etc/fail2ban/jail.local << EOF</div>
                <div>[sshd]</div>
                <div>enabled = true</div>
                <div>port = ssh</div>
                <div>filter = sshd</div>
                <div>logpath = /var/log/auth.log</div>
                <div>maxretry = 3        # 3å›å¤±æ•—ã§é®æ–­</div>
                <div>bantime = 3600      # 1æ™‚é–“é®æ–­</div>
                <div>findtime = 600      # 10åˆ†é–“ã§ã®å¤±æ•—å›æ•°ã‚’ç›£è¦–</div>
                <div>EOF</div>
            </div>

            <h4>fail2bané‹ç”¨é–‹å§‹</h4>
            <div class="command">
                <div># fail2banã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹åŒ–</div>
                <div>sudo systemctl enable fail2ban</div>
                <div></div>
                <div># fail2banã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹</div>
                <div>sudo systemctl start fail2ban</div>
                <div></div>
                <div># å‹•ä½œçŠ¶æ³ç¢ºèª</div>
                <div>sudo systemctl status fail2ban</div>
                <div></div>
                <div># SSHä¿è­·çŠ¶æ³ç¢ºèª</div>
                <div>sudo fail2ban-client status sshd</div>
                <div></div>
                <div># é®æ–­ã•ã‚ŒãŸIPç¢ºèª</div>
                <div>sudo fail2ban-client get sshd banip</div>
            </div>

            <h4>fail2banç®¡ç†ã‚³ãƒãƒ³ãƒ‰</h4>
            <div class="command">
                <div># ç‰¹å®šIPã®æ‰‹å‹•é®æ–­</div>
                <div>sudo fail2ban-client set sshd banip ATTACKER_IP</div>
                <div></div>
                <div># ç‰¹å®šIPã®é®æ–­è§£é™¤</div>
                <div>sudo fail2ban-client set sshd unbanip ATTACKER_IP</div>
                <div></div>
                <div># å…¨ã¦ã®é®æ–­IPè¡¨ç¤º</div>
                <div>sudo iptables -L f2b-sshd</div>
                <div></div>
                <div># fail2banãƒ­ã‚°ç¢ºèª</div>
                <div>sudo tail -f /var/log/fail2ban.log</div>
            </div>

            <div class="success">
                <strong>åŠ¹æœ:</strong> SSHæ”»æ’ƒã‚’è‡ªå‹•æ¤œçŸ¥ã—ã€æ”»æ’ƒè€…IPã‚’å³åº§ã«é®æ–­ã™ã‚‹ã“ã¨ã§ã€
                é•·æ™‚é–“ã®æ”»æ’ƒã‚„APTæ”»æ’ƒã®åˆæœŸæ®µéšã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚
            </div>

            <h3>12.4 è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®è¨­å®š</h3>

            <h4>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ</h4>
            <div class="step-container">
                <div class="step">
                    <strong>ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ</strong>
                    <div class="command">
# ç©ºã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
sudo touch /usr/local/bin/security_scan.sh
                    </div>
                </div>

                <div class="step">
                    <strong>ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…å®¹ã®ç·¨é›†</strong>
                    <div class="command">
# vimã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç·¨é›†
sudo vim /usr/local/bin/security_scan.sh

# ä»¥ä¸‹ã®å†…å®¹ã‚’å…¥åŠ›:
#!/bin/bash
echo "=== Daily Security Scan $(date) ==="

# 1. SSHæ”»æ’ƒç¢ºèª
echo "SSH Attack Count: $(grep "$(date '+%b %d')" /var/log/auth.log | grep -E "Failed|Invalid" | wc -l)"

# 2. fail2bançŠ¶æ³
echo "Banned IPs: $(sudo fail2ban-client status sshd | grep "Banned IP list" | cut -d: -f2)"

# 3. ä¸å¯©ãªãƒ—ãƒ­ã‚»ã‚¹
echo "Suspicious processes:"
ps aux | grep -v -E "(systemd|kernel|kthreadd)" | head -5

# 4. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š
echo "Network connections:"
netstat -tn | grep -E ":22|:80|:443" | wc -l

echo "=== Scan Complete ==="
                    </div>
                </div>

                <div class="step">
                    <strong>å®Ÿè¡Œæ¨©é™ã®ä»˜ä¸</strong>
                    <div class="command">
# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
sudo chmod +x /usr/local/bin/security_scan.sh
                    </div>
                </div>

                <div class="step">
                    <strong>ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</strong>
                    <div class="command">
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®å®Ÿè¡Œ
sudo /usr/local/bin/security_scan.sh
                    </div>
                </div>
            </div>

            <h4>ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯</h4>
            <div class="command">
# æœ€è¿‘å¤‰æ›´ã•ã‚ŒãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
sudo find /etc -name "*.conf" -mtime -1 2>/dev/null

# ä¸å¯©ãªcronè¨­å®šç¢ºèª
sudo ls -la /etc/cron*

# ç¾åœ¨ã®æ¥ç¶šç¢ºèª
netstat -tn | grep -E ":22|:80|:443"

# ä¸å¯©ãªãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
ps aux | grep -v -E "(systemd|kernel)" | head -20

# æœ€è¿‘ã®ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ç¢ºèª
find /tmp /var/tmp -type f -mtime -1 2>/dev/null
            </div>

            <div class="check">
                <h4>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®åŠ¹æœ</h4>
                <ul>
                    <li><strong>æ—¥æ¬¡ãƒã‚§ãƒƒã‚¯:</strong> æ¯æ—¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚’è‡ªå‹•ç¢ºèª</li>
                    <li><strong>æ”»æ’ƒæ¤œçŸ¥:</strong> SSHæ”»æ’ƒã¨fail2banå‹•ä½œçŠ¶æ³ã‚’ç›£è¦–</li>
                    <li><strong>ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–:</strong> ä¸å¯©ãªãƒ—ãƒ­ã‚»ã‚¹ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª</li>
                    <li><strong>å¤‰æ›´æ¤œçŸ¥:</strong> ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã®æ”¹ã–ã‚“ã‚’æ¤œå‡º</li>
                </ul>
            </div>
        </section>

        <section id="incident-response">
            <h2>ğŸš¨ 13. ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †</h2>

            <h3>13.1 æ”»æ’ƒæ¤œçŸ¥æ™‚ã®ç·Šæ€¥å¯¾å¿œ</h3>
            <div class="step-container">
                <div class="step">
                    <strong>çŠ¶æ³ç¢ºèª</strong>
                    <div class="command">
# ç¾åœ¨ã®æ¥ç¶šç¢ºèª
netstat -tn | grep -E ":22|:80|:443"

# ä¸å¯©ãªãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
ps aux | grep -v -E "(systemd|kernel)" | head -20

# æœ€è¿‘ã®ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´
find /tmp /var/tmp -type f -mtime -1 2>/dev/null
                    </div>
                </div>

                <div class="step">
                    <strong>ä¸æ­£æ¥ç¶šã®åˆ‡æ–­</strong>
                    <div class="command">
# ç‰¹å®šIPã‹ã‚‰ã®æ¥ç¶šåˆ‡æ–­
sudo ss -K dst ATTACKER_IP

# SSHæ¥ç¶šã®å¼·åˆ¶åˆ‡æ–­
sudo pkill -f "sshd.*ATTACKER_IP"

# ä¸å¯©ãªãƒ—ãƒ­ã‚»ã‚¹ã®åœæ­¢
sudo kill -9 PID
                    </div>
                </div>

                <div class="step">
                    <strong>é˜²å¾¡ã®å®Ÿè£…</strong>
                    <div class="command">
# æ”»æ’ƒIPã®å³åº§é®æ–­
sudo iptables -I INPUT -s ATTACKER_IP -j DROP

# SSHç·Šæ€¥åœæ­¢
sudo systemctl stop ssh
sudo systemctl mask ssh

# Webã‚µãƒ¼ãƒ“ã‚¹ã®ä¸€æ™‚åœæ­¢ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
sudo systemctl stop nginx
                    </div>
                </div>
            </div>

            <h3>13.2 è¨¼æ‹ ä¿å…¨</h3>
            <div class="command">
# ãƒ­ã‚°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
sudo cp /var/log/auth.log /backup/auth.log.$(date +%Y%m%d_%H%M%S)
sudo cp /var/log/nginx/access.log /backup/access.log.$(date +%Y%m%d_%H%M%S)

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã®è¨˜éŒ²
netstat -tulpn > /backup/netstat.$(date +%Y%m%d_%H%M%S).txt

# ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§ã®è¨˜éŒ²
ps aux > /backup/processes.$(date +%Y%m%d_%H%M%S).txt
            </div>

            <h3>13.3 ã‚·ã‚¹ãƒ†ãƒ å¾©æ—§æ‰‹é †</h3>
            <div class="step-container">
                <div class="step">
                    <strong>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªãƒ»ä¿®å¾©</strong>
                    <div class="command">
                        <div># SSHè¨­å®šã®ç¢ºèª</div>
                        <div>sudo sshd -t</div>
                        <div></div>
                        <div># nginxè¨­å®šã®ç¢ºèª</div>
                        <div>sudo nginx -t</div>
                        <div></div>
                        <div># ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ç¢ºèª</div>
                        <div>sudo find /etc -name "*.conf" -mtime -1</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ã‚µãƒ¼ãƒ“ã‚¹ã®æ®µéšçš„å¾©æ—§</strong>
                    <div class="command">
                        <div># nginxå…ˆè¡Œå¾©æ—§</div>
                        <div>sudo systemctl start nginx</div>
                        <div>sudo systemctl status nginx</div>
                        <div></div>
                        <div># Djangoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•</div>
                        <div>sudo systemctl restart gunicorn</div>
                        <div>sudo systemctl status gunicorn</div>
                        <div></div>
                        <div># SSHå¾©æ—§ï¼ˆè¨­å®šå¼·åŒ–å¾Œï¼‰</div>
                        <div>sudo systemctl unmask ssh</div>
                        <div>sudo systemctl start ssh</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="django-monitoring">
            <h2>ğŸ“Š 9. Django ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–</h2>

            <h3>9.1 Django ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨­å®š</h3>
            <div class="step-container">
                <div class="step">
                    <strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°å¼·åŒ–</strong>
                    <div class="command">
                        <div># settings.py ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨­å®š</div>
                        <div>LOGGING = {</div>
                        <div>    'version': 1,</div>
                        <div>    'handlers': {</div>
                        <div>        'security_file': {</div>
                        <div>            'level': 'WARNING',</div>
                        <div>            'class': 'logging.handlers.RotatingFileHandler',</div>
                        <div>            'filename': '/var/log/django_security.log',</div>
                        <div>            'maxBytes': 10485760,  # 10MB</div>
                        <div>            'backupCount': 5,</div>
                        <div>            'formatter': 'verbose',</div>
                        <div>        },</div>
                        <div>        'auth_file': {</div>
                        <div>            'level': 'INFO',</div>
                        <div>            'class': 'logging.handlers.RotatingFileHandler',</div>
                        <div>            'filename': '/var/log/django_auth.log',</div>
                        <div>            'maxBytes': 10485760,</div>
                        <div>            'backupCount': 5,</div>
                        <div>            'formatter': 'verbose',</div>
                        <div>        },</div>
                        <div>    },</div>
                        <div>    'loggers': {</div>
                        <div>        'django.security': {</div>
                        <div>            'handlers': ['security_file'],</div>
                        <div>            'level': 'WARNING',</div>
                        <div>            'propagate': False,</div>
                        <div>        },</div>
                        <div>        'django.contrib.auth': {</div>
                        <div>            'handlers': ['auth_file'],</div>
                        <div>            'level': 'INFO',</div>
                        <div>            'propagate': False,</div>
                        <div>        },</div>
                        <div>    },</div>
                        <div>}</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢</strong>
                    <div class="command">
                        <div># security_middleware.py</div>
                        <div>import logging</div>
                        <div>from django.utils.deprecation import MiddlewareMixin</div>
                        <div>from django.http import HttpResponseForbidden</div>
                        <div>import re</div>
                        <div></div>
                        <div>logger = logging.getLogger('django.security')</div>
                        <div></div>
                        <div>class SecurityLoggingMiddleware(MiddlewareMixin):</div>
                        <div>    def process_request(self, request):</div>
                        <div>        # ä¸å¯©ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œçŸ¥</div>
                        <div>        suspicious_patterns = [</div>
                        <div>            r'<script[^>]*>.*?</script>',  # XSS</div>
                        <div>            r'(union|select|drop|insert|delete)',  # SQLi</div>
                        <div>            r'\.\./.*',  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«</div>
                        <div>            r'(cmd|exec|system)\s*\(',  # ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³</div>
                        <div>        ]</div>
                        <div>        </div>
                        <div>        request_data = str(request.GET) + str(request.POST)</div>
                        <div>        for pattern in suspicious_patterns:</div>
                        <div>            if re.search(pattern, request_data, re.IGNORECASE):</div>
                        <div>                logger.warning(f'Suspicious request from {request.META.get("REMOTE_ADDR")}: {pattern}')</div>
                        <div>                return HttpResponseForbidden('ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã™')</div>
                        <div>        </div>
                        <div>        return None</div>
                    </div>
                </div>
            </div>

            <h3>9.2 Django ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ„ãƒ¼ãƒ«</h3>
            <div class="step-container">
                <div class="step">
                    <strong>Django ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯</strong>
                    <div class="command">
                        <div># ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰</div>
                        <div>python manage.py check --deploy</div>
                        
                        <div># è¨­å®šå€¤æ¤œè¨¼</div>
                        <div>python manage.py check --tag security</div>
                        
                        <div># ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œè¨¼</div>
                        <div>python manage.py check --database default</div>
                        
                        <div># ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯</div>
                        <div>pip install safety</div>
                        <div>safety check --json</div>
                        
                        <div># Banditã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»</div>
                        <div>pip install bandit</div>
                        <div>bandit -r . -f json -o security_audit.json</div>
                    </div>
                </div>

                <div class="step">
                    <strong>Django Debug Toolbar ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong>
                    <div class="command">
                        <div># æœ¬ç•ªç’°å¢ƒã§ã®Debugç„¡åŠ¹åŒ–ç¢ºèª</div>
                        <div>if DEBUG:</div>
                        <div>    raise Exception('æœ¬ç•ªç’°å¢ƒã§DEBUG=Trueã¯å±é™ºã§ã™')</div>
                        
                        <div># ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®å®‰å…¨ãªè¨­å®š</div>
                        <div>if DEBUG:</div>
                        <div>    INTERNAL_IPS = ['127.0.0.1', '::1']</div>
                        <div>    INSTALLED_APPS += ['debug_toolbar']</div>
                        <div>    MIDDLEWARE += ['debug_toolbar.middleware.DebugToolbarMiddleware']</div>
                        <div>    DEBUG_TOOLBAR_CONFIG = {</div>
                        <div>        'SHOW_TOOLBAR_CALLBACK': lambda request: DEBUG and request.META.get('REMOTE_ADDR') in INTERNAL_IPS,</div>
                        <div>    }</div>
                    </div>
                </div>
            </div>

            <h3>9.3 Django ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–</h3>
            <div class="command">
                <div># django-silk ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–</div>
                <div>pip install django-silk</div>
                
                <div># settings.py è¨­å®š</div>
                <div>if not DEBUG:  # æœ¬ç•ªç’°å¢ƒã®ã¿</div>
                <div>    INSTALLED_APPS += ['silk']</div>
                <div>    MIDDLEWARE += ['silk.middleware.SilkyMiddleware']</div>
                
                <div># ç•°å¸¸ãªã‚¯ã‚¨ãƒªæ¤œå‡º</div>
                <div>SILKY_MAX_RECORDED_REQUESTS = 10**4</div>
                <div>SILKY_MAX_RECORDED_REQUESTS_CHECK_PERCENT = 10</div>
                
                <div># ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–</div>
                <div>import psutil</div>
                <div>def check_memory_usage():</div>
                <div>    memory = psutil.virtual_memory()</div>
                <div>    if memory.percent > 90:</div>
                <div>        logger.warning(f'High memory usage: {memory.percent}%')</div>
            </div>
        </section>

        <section id="incident-response-advanced">
            <h2>ğŸš¨ 11. é«˜åº¦ãªã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ</h2>

            <h3>11.1 Django ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ¬ãƒ³ã‚¸ãƒƒã‚¯</h3>
            <div class="step-container">
                <div class="step">
                    <strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ”¹ã–ã‚“æ¤œçŸ¥</strong>
                    <div class="command">
                        <div># ãƒ¢ãƒ‡ãƒ«å¤‰æ›´å±¥æ­´è¿½è·¡</div>
                        <div>pip install django-simple-history</div>
                        
                        <div># models.py è¨­å®š</div>
                        <div>from simple_history.models import HistoricalRecords</div>
                        <div></div>
                        <div>class CriticalData(models.Model):</div>
                        <div>    name = models.CharField(max_length=100)</div>
                        <div>    value = models.TextField()</div>
                        <div>    history = HistoricalRecords()</div>
                        
                        <div># æ”¹ã–ã‚“æ¤œçŸ¥ã‚¯ã‚¨ãƒª</div>
                        <div>from simple_history.utils import update_change_reason</div>
                        <div></div>
                        <div># çŸ­æ™‚é–“ã§ã®å¤§é‡å¤‰æ›´æ¤œçŸ¥</div>
                        <div>suspicious_changes = CriticalData.history.filter(</div>
                        <div>    history_date__gte=timezone.now() - timedelta(minutes=5)</div>
                        <div>).count()</div>
                        <div></div>
                        <div>if suspicious_changes > 100:</div>
                        <div>    logger.error(f'Suspicious bulk changes detected: {suspicious_changes}')</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯æ¤œçŸ¥</strong>
                    <div class="command">
                        <div># ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</div>
                        <div>from django.contrib.sessions.backends.db import SessionStore as DBStore</div>
                        <div>import logging</div>
                        <div></div>
                        <div>logger = logging.getLogger('django.security')</div>
                        <div></div>
                        <div>class SecuritySessionStore(DBStore):</div>
                        <div>    def create_model_instance(self, data):</div>
                        <div>        # IPã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´æ¤œçŸ¥</div>
                        <div>        if 'user_ip' in data and 'current_ip' in data:</div>
                        <div>            if data['user_ip'] != data['current_ip']:</div>
                        <div>                logger.warning(f'Session IP changed: {data["user_ip"]} -> {data["current_ip"]}')</div>
                        <div>                self.flush()  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–</div>
                        <div>        </div>
                        <div>        return super().create_model_instance(data)</div>
                        
                        <div># settings.py è¨­å®š</div>
                        <div>SESSION_ENGINE = 'your_app.sessions.SecuritySessionStore'</div>
                    </div>
                </div>
            </div>

            <h3>11.2 è‡ªå‹•å¾©æ—§ã‚·ã‚¹ãƒ†ãƒ </h3>
            <div class="command">
                <div># è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</div>
                <div>#!/bin/bash</div>
                <div># django_backup_restore.sh</div>
                <div></div>
                <div>BACKUP_DIR="/var/backups/daihatsu"</div>
                <div>TIMESTAMP=$(date +%Y%m%d_%H%M%S)</div>
                <div></div>
                <div># PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
                <div>python manage.py dbbackup --compress</div>
                <div>pg_dump -U user -h localhost db > $BACKUP_DIR/db_$TIMESTAMP.sql</div>
                <div></div>
                <div># è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
                <div>tar -czf $BACKUP_DIR/config_$TIMESTAMP.tar.gz daihatsu/settings.py</div>
                <div></div>
                <div># ç•°å¸¸æ¤œçŸ¥æ™‚ã®è‡ªå‹•å¾©æ—§</div>
                <div>if [ "$1" = "restore" ]; then</div>
                <div>    systemctl stop gunicorn</div>
                <div>    psql -U user -h localhost db < $BACKUP_DIR/db_latest.sql</div>
                <div>    systemctl start gunicorn</div>
                <div>    logger "Django database restored from backup"</div>
                <div>fi</div>
            </div>
        </section>

        <section id="daihatsu-vulnerabilities">
            <h2>ğŸš¨ 10. daihatsuãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è„†å¼±æ€§å¯¾ç­–</h2>

            <h3>10.1 ç·Šæ€¥ä¿®æ­£é …ç›®ï¼ˆå„ªå…ˆåº¦ï¼šé«˜ï¼‰</h3>
            <div class="danger">
                <strong>é‡è¦:</strong> ä»¥ä¸‹ã®è„†å¼±æ€§ã¯å³åº§ã«ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚
            </div>

            <div class="step-container">
                <div class="step">
                    <strong>SECRET_KEYã®ç’°å¢ƒå¤‰æ•°åŒ–</strong>
                    <div class="command">
                        <div># ç¾åœ¨ã®å±é™ºãªè¨­å®šç¢ºèª</div>
                        <div>grep -n "SECRET_KEY.*django-insecure" daihatsu/settings.py</div>
                        <div></div>
                        <div># ç’°å¢ƒå¤‰æ•°ã§ã®è¨­å®š</div>
                        <div>export SECRET_KEY="$(python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')"</div>
                        <div>echo "SECRET_KEY=$SECRET_KEY" >> .env</div>
                        <div></div>
                        <div># settings.pyã®ä¿®æ­£</div>
                        <div>sed -i "s/SECRET_KEY = 'django-insecure-.*/SECRET_KEY = os.environ.get('SECRET_KEY', 'fallback-only-for-dev')/" daihatsu/settings.py</div>
                    </div>
                </div>

                <div class="step">
                    <strong>DEBUGãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ä¿®æ­£</strong>
                    <div class="command">
                        <div># ç¾åœ¨ã®å±é™ºãªè¨­å®šç¢ºèª</div>
                        <div>grep -n "DEBUG.*'True'" daihatsu/settings.py</div>
                        <div></div>
                        <div># ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’Falseã«å¤‰æ›´</div>
                        <div>sed -i "s/DEBUG = os.environ.get('DEBUG', 'True')/DEBUG = os.environ.get('DEBUG', 'False')/" daihatsu/settings.py</div>
                        <div></div>
                        <div># è¨­å®šç¢ºèª</div>
                        <div>python -c "from daihatsu import settings; print(f'DEBUG: {settings.DEBUG}')"</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¼·åŒ–</strong>
                    <div class="command">
                        <div># å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆæ–¹æ³•1: OpenSSLï¼‰</div>
                        <div>NEW_DB_PASSWORD=$(openssl rand -base64 32)</div>
                        <div>echo "POSTGRES_PASSWORD=$NEW_DB_PASSWORD" >> .env</div>
                        <div></div>
                        <div># å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆæ–¹æ³•2: Python secretsï¼‰</div>
                        <div>python3 -c "import secrets, string; print(''.join(secrets.choice(string.ascii_letters + string.digits + '!@#$%^&*') for _ in range(24)))" > temp_pass.txt</div>
                        <div>echo "POSTGRES_PASSWORD=$(cat temp_pass.txt)" >> .env</div>
                        <div>rm temp_pass.txt</div>
                        <div></div>
                        <div># Docker Composeè¨­å®šæ›´æ–°</div>
                        <div>sed -i "s/POSTGRES_PASSWORD=password/POSTGRES_PASSWORD=\${POSTGRES_PASSWORD}/" docker-compose.yml</div>
                        <div></div>
                        <div># settings.pyæ›´æ–°</div>
                        <div>sed -i "s/'PASSWORD': 'password'/'PASSWORD': os.environ.get('POSTGRES_PASSWORD', 'fallback')/" daihatsu/settings.py</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰äº‹å‰å…¥åŠ›å‰Šé™¤</strong>
                    <div class="command">
                        <div># å±é™ºãªè¨­å®šç¢ºèª</div>
                        <div>grep -n 'value="password"' daihatsu/templates/auth/login.html</div>
                        <div></div>
                        <div># äº‹å‰å…¥åŠ›ã‚’å‰Šé™¤</div>
                        <div>sed -i 's/value="password"//' daihatsu/templates/auth/login.html</div>
                        <div></div>
                        <div># ä¿®æ­£ç¢ºèª</div>
                        <div>grep -n 'type="password"' daihatsu/templates/auth/login.html</div>
                    </div>
                </div>
            </div>

            <h3>10.2 ä¸­å„ªå…ˆåº¦ã®ä¿®æ­£é …ç›®</h3>
            <div class="step-container">
                <div class="step">
                    <strong>Content Security Policy (CSP)ã®å®Ÿè£…</strong>
                    <div class="command">
                        <div># django-csp ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                        <div>pip install django-csp</div>
                        <div></div>
                        <div># settings.py INSTALLED_APPSè¿½åŠ </div>
                        <div>INSTALLED_APPS += ['csp']</div>
                        <div></div>
                        <div># CSPè¨­å®šè¿½åŠ </div>
                        <div>CSP_DEFAULT_SRC = ("'self'",)</div>
                        <div>CSP_SCRIPT_SRC = ("'self'", "'unsafe-inline'", "cdn.jsdelivr.net", "cdnjs.cloudflare.com")</div>
                        <div>CSP_STYLE_SRC = ("'self'", "'unsafe-inline'", "cdn.jsdelivr.net", "cdnjs.cloudflare.com")</div>
                        <div>CSP_IMG_SRC = ("'self'", "data:", "https:")</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¿½åŠ </strong>
                    <div class="command">
                        <div># ç¾åœ¨ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®šç¢ºèª</div>
                        <div>python -c "from daihatsu.settings import MIDDLEWARE; [print(m) for m in MIDDLEWARE]"</div>
                        <div></div>
                        <div># ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å¼·åŒ–</div>
                        <div>MIDDLEWARE = [</div>
                        <div>    'django.middleware.security.SecurityMiddleware',</div>
                        <div>    'csp.middleware.CSPMiddleware',  # CSPè¿½åŠ </div>
                        <div>    'daihatsu.middleware.IPSpoofingDetectionMiddleware',</div>
                        <div>    # æ—¢å­˜ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç¶™ç¶š...</div>
                        <div>]</div>
                    </div>
                </div>
            </div>

            <h3>10.3 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è„†å¼±æ€§æ¤œè¨¼</h3>
            <div class="command">
                <div># daihatsuå›ºæœ‰ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯</div>
                <div>python manage.py check --deploy --fail-level WARNING</div>
                <div></div>
                <div># ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šç¢ºèª</div>
                <div>python -c "from daihatsu.models import CustomUser; print(f'ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œåˆ¶é™: {CustomUser._meta.get_field(\"miss_count\")}')"</div>
                <div></div>
                <div># IPå½è£…æ¤œå‡ºæ©Ÿèƒ½ã®ç¢ºèª</div>
                <div>python -c "from daihatsu.middleware import IPSpoofingDetectionMiddleware; print('IPå½è£…æ¤œå‡º: æœ‰åŠ¹')"</div>
                <div></div>
                <div># ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®ç¢ºèª</div>
                <div>ls -la log/ | grep -E "(sql|security|performance)"</div>
                <div></div>
                <div># ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹ã¾ã¨ã‚</div>
                <div>python -c "
from daihatsu import settings
print('=== daihatsu ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹ ===')
print(f'DEBUG: {settings.DEBUG}')
print(f'SECRET_KEYå®‰å…¨: {\"OK\" if not settings.SECRET_KEY.startswith(\"django-insecure\") else \"NG\"}')
print(f'ALLOWED_HOSTS: {settings.ALLOWED_HOSTS}')
print(f'AUTH_USER_MODEL: {getattr(settings, \"AUTH_USER_MODEL\", \"default\")}')
"</div>
            </div>
        </section>

        <section id="verification">
            <h2>âœ… 14. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰</h2>

            <h3>14.1 ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ç¢ºèª</h3>
            <table>
                <tr>
                    <th>é …ç›®</th>
                    <th>ç¢ºèªã‚³ãƒãƒ³ãƒ‰</th>
                    <th>æœŸå¾…çµæœ</th>
                </tr>
                <tr>
                    <td>SSHçŠ¶æ…‹</td>
                    <td><code>sudo systemctl status ssh</code></td>
                    <td>inactive (stopped) ã¾ãŸã¯ masked</td>
                </tr>
                <tr>
                    <td>é–‹æ”¾ãƒãƒ¼ãƒˆ</td>
                    <td><code>sudo netstat -tulpn | grep LISTEN</code></td>
                    <td>80, 443, 8000(localhost)ã®ã¿</td>
                </tr>
                <tr>
                    <td>ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«</td>
                    <td><code>sudo iptables -L INPUT</code></td>
                    <td>5432, 8080 ãŒ DROP</td>
                </tr>
                <tr>
                    <td>nginxçŠ¶æ…‹</td>
                    <td><code>sudo systemctl status nginx</code></td>
                    <td>active (running)</td>
                </tr>
                <tr>
                    <td>ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ³</td>
                    <td><code>sudo docker ps</code></td>
                    <td>å¿…è¦ãªã‚³ãƒ³ãƒ†ãƒŠã®ã¿ç¨¼åƒ</td>
                </tr>
            </table>

            <h3>14.2 å¤–éƒ¨ã‹ã‚‰ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ</h3>
            <div class="command">
# æ­£å¸¸ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆæˆåŠŸã™ã‚‹ã¹ãï¼‰
curl -I https://maruomosquit.com/
curl -I https://maruomosquit.com/admin/

# é®æ–­ãƒ†ã‚¹ãƒˆï¼ˆå¤±æ•—ã™ã‚‹ã¹ãï¼‰
curl -I http://SERVER_IP:8000/ --connect-timeout 5
curl -I http://SERVER_IP:5432/ --connect-timeout 5

# SSHæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆå¤±æ•—ã™ã‚‹ã¹ãï¼‰
ssh user@SERVER_IP -o ConnectTimeout=5
            </div>

            <h3>14.3 ãƒ­ã‚°åˆ†æã«ã‚ˆã‚‹è„…å¨ç¢ºèª</h3>
            <div class="command">
                <div># æœ€è¿‘ã®æ”»æ’ƒè©¦è¡Œç¢ºèª</div>
                <div>sudo grep "$(date '+%b %d')" /var/log/auth.log | grep -E "Failed|Invalid" | wc -l</div>
                <div></div>
                <div># nginxæ”»æ’ƒãƒ­ã‚°ç¢ºèª</div>
                <div>sudo grep "$(date '+%d/%b/%Y')" /var/log/nginx/access.log | grep -E "40[0-9]|50[0-9]" | wc -l</div>
                <div></div>
                <div># fail2banãƒãƒ³çŠ¶æ³</div>
                <div>sudo fail2ban-client status</div>
                <div></div>
                <div># ä¸å¯©ãªãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª</div>
                <div>ps aux | grep -v -E "(root|www-data|django)" | grep -v "grep"</div>
            </div>

            <h3>14.4 ã‚·ã‚¹ãƒ†ãƒ æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯</h3>
            <div class="command">
                <div># é‡è¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª</div>
                <div>sudo find /etc/nginx /etc/ssh -name "*.conf" -exec ls -la {} \;</div>
                <div></div>
                <div># æœ€è¿‘å¤‰æ›´ã•ã‚ŒãŸã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«</div>
                <div>sudo find /usr/bin /usr/sbin -mtime -7 -type f 2>/dev/null</div>
                <div></div>
                <div># ä¸å¯©ãªcronè¨­å®š</div>
                <div>sudo find /etc/cron* -type f -exec cat {} \; 2>/dev/null</div>
                <div></div>
                <div># ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª</div>
                <div>df -h</div>
                <div>free -m</div>
                <div>uptime</div>
            </div>
        </section>

        <section id="django-security">
            <h2>ğŸ 4. Django ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h2>

            <h3>4.1 Django settings.py ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h3>
            <div class="step-container">
                <div class="step">
                    <strong>åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</strong>
                    <div class="command">
                        <div># ç·Šæ€¥ä¿®æ­£é …ç›®ï¼ˆé«˜å„ªå…ˆï¼‰</div>
                        <div>SECRET_KEY = os.environ.get('SECRET_KEY', 'fallback-only-for-dev')</div>
                        <div>DEBUG = os.environ.get('DEBUG', 'False').lower() == 'true'  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆFalse</div>
                        <div></div>
                        <div># åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</div>
                        <div>ALLOWED_HOSTS = ['maruomosquit.com', 'www.maruomosquit.com']</div>
                        <div>CSRF_TRUSTED_ORIGINS = ['https://maruomosquit.com', 'https://www.maruomosquit.com']</div>
                        <div></div>
                        <div># HTTPSè¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰</div>
                        <div>if not DEBUG:</div>
                        <div>    SECURE_SSL_REDIRECT = True</div>
                        <div>    SECURE_HSTS_SECONDS = 31536000</div>
                        <div>    SECURE_HSTS_INCLUDE_SUBDOMAINS = True</div>
                        <div>    SECURE_HSTS_PRELOAD = True</div>
                        <div></div>
                        <div># ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</div>
                        <div>SESSION_COOKIE_SECURE = True</div>
                        <div>SESSION_COOKIE_HTTPONLY = True</div>
                        <div>SESSION_COOKIE_SAMESITE = 'Strict'</div>
                        <div>SESSION_COOKIE_AGE = 3600  # 1æ™‚é–“</div>
                        <div>SESSION_SAVE_EVERY_REQUEST = True</div>
                        <div>SESSION_EXPIRE_AT_BROWSER_CLOSE = True</div>
                        <div></div>
                        <div># CSRFä¿è­·</div>
                        <div>CSRF_COOKIE_SECURE = True</div>
                        <div>CSRF_COOKIE_HTTPONLY = True</div>
                        <div>CSRF_COOKIE_SAMESITE = 'Strict'</div>
                    </div>
                </div>

                <div class="step">
                    <strong>SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–</strong>
                    <div class="command">
                        <div># ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šç¢ºèª</div>
                        <div>python manage.py check --deploy</div>
                        
                        <div># ORMä½¿ç”¨æ¨å¥¨ï¼ˆraw SQLé¿ã‘ã‚‹ï¼‰</div>
                        <div># æ‚ªã„ä¾‹: User.objects.raw("SELECT * FROM users WHERE id = %s" % user_id)</div>
                        <div># è‰¯ã„ä¾‹: User.objects.filter(id=user_id)</div>
                        
                        <div># ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªä½¿ç”¨</div>
                        <div>cursor.execute("SELECT * FROM users WHERE id = %s", [user_id])</div>
                    </div>
                </div>

                <div class="step">
                    <strong>XSSãƒ»CSRFå¯¾ç­–</strong>
                    <div class="command">
                        <div># ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã®è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ç¢ºèª</div>
                        <div>{{ user_input|escape }}  # æ‰‹å‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—</div>
                        <div>{% autoescape on %}...{% endautoescape %}</div>
                        
                        <div># CSRF ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª</div>
                        <div>grep -r "csrf_token" templates/</div>
                        
                        <div># Content Security Policyè¨­å®š</div>
                        <div>SECURE_CONTENT_TYPE_NOSNIFF = True</div>
                        <div>SECURE_BROWSER_XSS_FILTER = True</div>
                    </div>
                </div>
            </div>

            <h3>4.2 Django ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»</h3>
            <div class="command">
                <div># daihatsuãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç·Šæ€¥è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯</div>
                <div>python manage.py check --deploy</div>
                <div></div>
                <div># SECRET_KEYç¢ºèªï¼ˆç·Šæ€¥ï¼‰</div>
                <div>python -c "from daihatsu import settings; print('CRITICAL: SECRET_KEYãŒä¸å®‰å…¨' if settings.SECRET_KEY.startswith('django-insecure') and not settings.DEBUG else 'OK')"</div>
                <div></div>
                <div># DEBUGè¨­å®šç¢ºèª</div>
                <div>python -c "from daihatsu import settings; print('WARNING: DEBUGãŒTrue' if settings.DEBUG else 'OK')"</div>
                <div></div>
                <div># ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</div>
                <div>pip install bandit safety</div>
                <div></div>
                <div># ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³</div>
                <div>bandit -r daihatsu/ -f json -o daihatsu_security_report.json</div>
                <div></div>
                <div># ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯</div>
                <div>safety check --json</div>
            </div>

            <h3>4.3 Django ãƒ­ã‚°è¨­å®š</h3>
            <div class="config">
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'WARNING',
            'class': 'logging.FileHandler',
            'filename': '/var/log/django.log',
            'formatter': 'verbose',
        },
        'security': {
            'level': 'ERROR',
            'class': 'logging.FileHandler', 
            'filename': '/var/log/django_security.log',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file'],
            'level': 'WARNING',
            'propagate': True,
        },
        'django.security': {
            'handlers': ['security'],
            'level': 'ERROR',
            'propagate': False,
        },
    },
}
            </div>
        </section>

        <section id="database-security">
            <h2>ğŸ—ƒï¸ 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h2>

            <h3>5.1 PostgreSQL ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h3>
            <div class="command">
                <div># PostgreSQLæ¥ç¶šåˆ¶é™è¨­å®š</div>
                <div>sudo -u postgres psql -c "ALTER SYSTEM SET listen_addresses = 'localhost';"</div>
                <div>sudo -u postgres psql -c "SELECT pg_reload_conf();"</div>
                <div></div>
                <div># ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
                <div>pg_dump -U user -h localhost db > backup_$(date +%Y%m%d).sql</div>
                <div></div>
                <div># ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯</div>
                <div>sudo -u postgres psql -d db -c "SELECT pg_database_size('db');"</div>
                <div>sudo -u postgres psql -d db -c "REINDEX DATABASE db;"</div>
            </div>

            <h3>5.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æš—å·åŒ–</h3>
            <div class="step-container">
                <div class="step">
                    <strong>æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–</strong>
                    <div class="command">
                        <div># Djangoæš—å·åŒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</div>
                        <div>pip install django-encrypted-model-fields</div>
                        
                        <div># settings.pyã«æš—å·åŒ–ã‚­ãƒ¼è¨­å®š</div>
                        <div>FIELD_ENCRYPTION_KEY = os.environ.get('FIELD_ENCRYPTION_KEY')</div>
                        
                        <div># ãƒ¢ãƒ‡ãƒ«ã§ã®ä½¿ç”¨ä¾‹</div>
                        <div>from encrypted_model_fields.fields import EncryptedCharField</div>
                        <div>sensitive_data = EncryptedCharField(max_length=255)</div>
                        
                        <div># å€‹äººæƒ…å ±æš—å·åŒ–ä¾‹</div>
                        <div>email = EncryptedEmailField()</div>
                        <div>phone_number = EncryptedCharField(max_length=20)</div>
                        <div>credit_card = EncryptedCharField(max_length=19)</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ç›£æŸ»</strong>
                    <div class="command">
                        <div># SQLã‚¯ã‚¨ãƒªãƒ­ã‚°æœ‰åŠ¹åŒ–</div>
                        <div>LOGGING['loggers']['django.db.backends'] = {</div>
                        <div>    'level': 'DEBUG',</div>
                        <div>    'handlers': ['file'],</div>
                        <div>}</div>
                        
                        <div># ä¸å¯©ãªã‚¯ã‚¨ãƒªæ¤œå‡º</div>
                        <div>grep -E "DROP|DELETE|UPDATE|INSERT" /var/log/django.log</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="django-advanced">
            <h2>ğŸ 6. Django é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</h2>

            <h3>6.1 Django ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢</h3>
            <div class="step-container">
                <div class="step">
                    <strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š</strong>
                    <div class="command">
                        <div># settings.py MIDDLEWAREè¨­å®š</div>
                        <div>MIDDLEWARE = [</div>
                        <div>    'django.middleware.security.SecurityMiddleware',  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼</div>
                        <div>    'django.contrib.sessions.middleware.SessionMiddleware',</div>
                        <div>    'django.middleware.common.CommonMiddleware',</div>
                        <div>    'django.middleware.csrf.CsrfViewMiddleware',  # CSRFä¿è­·</div>
                        <div>    'django.contrib.auth.middleware.AuthenticationMiddleware',</div>
                        <div>    'django.contrib.messages.middleware.MessageMiddleware',</div>
                        <div>    'django.middleware.clickjacking.XFrameOptionsMiddleware',  # ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°é˜²æ­¢</div>
                        <div>    'your_app.middleware.SecurityLoggingMiddleware',  # ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°</div>
                        <div>]</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢</strong>
                    <div class="command">
                        <div># django-ratelimitã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                        <div>pip install django-ratelimit</div>
                        
                        <div># ãƒ“ãƒ¥ãƒ¼ã§ã®ä½¿ç”¨ä¾‹</div>
                        <div>from django_ratelimit.decorators import ratelimit</div>
                        <div></div>
                        <div>@ratelimit(key='ip', rate='5/m', method='POST')</div>
                        <div>def login_view(request):</div>
                        <div>    # ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆ1åˆ†é–“ã«5å›ã¾ã§ï¼‰</div>
                        <div>    pass</div>
                        
                        <div>@ratelimit(key='user', rate='100/h')</div>
                        <div>def api_endpoint(request):</div>
                        <div>    # API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ1æ™‚é–“ã«100å›ã¾ã§ï¼‰</div>
                        <div>    pass</div>
                    </div>
                </div>
            </div>

            <h3>6.2 Django èªè¨¼ãƒ»èªå¯å¼·åŒ–</h3>
            <div class="step-container">
                <div class="step">
                    <strong>äºŒè¦ç´ èªè¨¼ã®å®Ÿè£…</strong>
                    <div class="command">
                        <div># django-otp ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                        <div>pip install django-otp qrcode[pil]</div>
                        
                        <div># settings.py è¨­å®š</div>
                        <div>INSTALLED_APPS += [</div>
                        <div>    'django_otp',</div>
                        <div>    'django_otp.plugins.otp_totp',</div>
                        <div>    'django_otp.plugins.otp_static',</div>
                        <div>]</div>
                        
                        <div>MIDDLEWARE += [</div>
                        <div>    'django_otp.middleware.OTPMiddleware',</div>
                        <div>]</div>
                        
                        <div># ç®¡ç†ç”»é¢ã§ã®2FAæœ‰åŠ¹åŒ–</div>
                        <div>OTP_TOTP_ISSUER = 'daihatsu-project'</div>
                        <div>OTP_ADMIN_HIDE_SENSITIVE_DATA = True</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼å¼·åŒ–</strong>
                    <div class="command">
                        <div># settings.py ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</div>
                        <div>AUTH_PASSWORD_VALIDATORS = [</div>
                        <div>    {</div>
                        <div>        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',</div>
                        <div>    },</div>
                        <div>    {</div>
                        <div>        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',</div>
                        <div>        'OPTIONS': {'min_length': 12,}  # 12æ–‡å­—ä»¥ä¸Š</div>
                        <div>    },</div>
                        <div>    {</div>
                        <div>        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',</div>
                        <div>    },</div>
                        <div>    {</div>
                        <div>        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',</div>
                        <div>    },</div>
                        <div>    {</div>
                        <div>        'NAME': 'your_app.validators.PasswordComplexityValidator',  # ã‚«ã‚¹ã‚¿ãƒ </div>
                        <div>    },</div>
                        <div>]</div>
                        
                        <div># ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœ‰åŠ¹æœŸé™è¨­å®š</div>
                        <div>PASSWORD_RESET_TIMEOUT = 3600  # 1æ™‚é–“</div>
                        <div>SESSION_COOKIE_AGE = 1800  # 30åˆ†ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™</div>
                    </div>
                </div>

                <div class="step">
                    <strong>æ¨©é™ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡</strong>
                    <div class="command">
                        <div># django-guardian ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                        <div>pip install django-guardian</div>
                        
                        <div># ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«æ¨©é™åˆ¶å¾¡</div>
                        <div>from guardian.decorators import permission_required</div>
                        <div>from guardian.shortcuts import assign_perm</div>
                        <div></div>
                        <div>@permission_required('myapp.view_document', (Document, 'pk', 'doc_id'))</div>
                        <div>def view_document(request, doc_id):</div>
                        <div>    # ç‰¹å®šã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¯¾ã™ã‚‹é–²è¦§æ¨©é™ãŒå¿…è¦</div>
                        <div>    pass</div>
                        
                        <div># å‹•çš„æ¨©é™ä»˜ä¸</div>
                        <div>assign_perm('myapp.change_document', user, document)</div>
                    </div>
                </div>
            </div>

            <h3>6.3 Django ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»Cookie ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
            <div class="command">
                <div># settings.py ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š</div>
                <div>SESSION_ENGINE = 'django.contrib.sessions.backends.signed_cookies'</div>
                <div>SESSION_COOKIE_SECURE = True  # HTTPSå¿…é ˆ</div>
                <div>SESSION_COOKIE_HTTPONLY = True  # JavaScriptä¸å¯</div>
                <div>SESSION_COOKIE_SAMESITE = 'Strict'  # CSRFæ”»æ’ƒé˜²æ­¢</div>
                <div>SESSION_COOKIE_NAME = 'daihatsu_sessionid'  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåå¤‰æ›´</div>
                
                <div># Cookieè¨­å®š</div>
                <div>CSRF_COOKIE_SECURE = True</div>
                <div>CSRF_COOKIE_HTTPONLY = True</div>
                <div>CSRF_COOKIE_SAMESITE = 'Strict'</div>
                
                <div># ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</div>
                <div>SESSION_SAVE_EVERY_REQUEST = True</div>
                <div>SESSION_EXPIRE_AT_BROWSER_CLOSE = True</div>
            </div>

            <h3>6.4 Django ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
            <div class="step-container">
                <div class="step">
                    <strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰åˆ¶é™</strong>
                    <div class="command">
                        <div># settings.py ãƒ•ã‚¡ã‚¤ãƒ«åˆ¶é™</div>
                        <div>FILE_UPLOAD_MAX_MEMORY_SIZE = 5242880  # 5MB</div>
                        <div>DATA_UPLOAD_MAX_MEMORY_SIZE = 5242880  # 5MB</div>
                        <div>DATA_UPLOAD_MAX_NUMBER_FIELDS = 1000</div>
                        
                        <div># è¨±å¯ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã®åˆ¶é™</div>
                        <div>ALLOWED_FILE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.gif', '.pdf', '.docx']</div>
                        
                        <div># ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š</div>
                        <div>MEDIA_ROOT = '/var/www/daihatsu/media/'</div>
                        <div>MEDIA_URL = '/media/'</div>
                        
                        <div># ãƒ•ã‚¡ã‚¤ãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³</div>
                        <div>DEFAULT_FILE_STORAGE = 'your_app.storage.SecureFileStorage'</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</strong>
                    <div class="command">
                        <div># ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼</div>
                        <div>import magic</div>
                        <div>from django.core.exceptions import ValidationError</div>
                        <div></div>
                        <div>def validate_file_extension(value):</div>
                        <div>    if not value.name.lower().endswith(('.jpg', '.png', '.pdf')):</div>
                        <div>        raise ValidationError('è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™')</div>
                        <div></div>
                        <div>def validate_file_size(value):</div>
                        <div>    if value.size > 5 * 1024 * 1024:  # 5MB</div>
                        <div>        raise ValidationError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™')</div>
                        <div></div>
                        <div>def validate_file_content(value):</div>
                        <div>    # MIMEã‚¿ã‚¤ãƒ—æ¤œè¨¼</div>
                        <div>    file_type = magic.from_buffer(value.read(1024), mime=True)</div>
                        <div>    allowed_types = ['image/jpeg', 'image/png', 'application/pdf']</div>
                        <div>    if file_type not in allowed_types:</div>
                        <div>        raise ValidationError('ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ãŒä¸æ­£ã§ã™')</div>
                    </div>
                </div>
            </div>

            <h3>6.5 Django API ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
            <div class="step-container">
                <div class="step">
                    <strong>Django REST Framework ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong>
                    <div class="command">
                        <div># DRF ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</div>
                        <div>REST_FRAMEWORK = {</div>
                        <div>    'DEFAULT_AUTHENTICATION_CLASSES': [</div>
                        <div>        'rest_framework.authentication.TokenAuthentication',</div>
                        <div>        'rest_framework.authentication.SessionAuthentication',</div>
                        <div>    ],</div>
                        <div>    'DEFAULT_PERMISSION_CLASSES': [</div>
                        <div>        'rest_framework.permissions.IsAuthenticated',</div>
                        <div>    ],</div>
                        <div>    'DEFAULT_THROTTLE_CLASSES': [</div>
                        <div>        'rest_framework.throttling.UserRateThrottle',</div>
                        <div>        'rest_framework.throttling.AnonRateThrottle',</div>
                        <div>    ],</div>
                        <div>    'DEFAULT_THROTTLE_RATES': {</div>
                        <div>        'user': '1000/hour',</div>
                        <div>        'anon': '100/hour',</div>
                        <div>    },</div>
                        <div>    'DEFAULT_RENDERER_CLASSES': [</div>
                        <div>        'rest_framework.renderers.JSONRenderer',  # XMLã¯ç„¡åŠ¹</div>
                        <div>    ],</div>
                        <div>}</div>
                    </div>
                </div>

                <div class="step">
                    <strong>APIå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</strong>
                    <div class="command">
                        <div># ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã§ã®å³æ ¼ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</div>
                        <div>from rest_framework import serializers</div>
                        <div>import re</div>
                        <div></div>
                        <div>class UserSerializer(serializers.ModelSerializer):</div>
                        <div>    email = serializers.EmailField()</div>
                        <div>    </div>
                        <div>    def validate_email(self, value):</div>
                        <div>        # ãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œè¨¼</div>
                        <div>        allowed_domains = ['example.com', 'company.co.jp']</div>
                        <div>        domain = value.split('@')[1]</div>
                        <div>        if domain not in allowed_domains:</div>
                        <div>            raise serializers.ValidationError('è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã™')</div>
                        <div>        return value</div>
                        <div></div>
                        <div>    def validate_phone(self, value):</div>
                        <div>        # é›»è©±ç•ªå·ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œè¨¼</div>
                        <div>        if not re.match(r'^[0-9-]{10,15}$', value):</div>
                        <div>            raise serializers.ValidationError('ä¸æ­£ãªé›»è©±ç•ªå·å½¢å¼ã§ã™')</div>
                        <div>        return value</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="threat-modeling">
            <h2>âš ï¸ 7. æ–°ã—ã„è„…å¨ã¨å¯¾å‡¦æ³•</h2>

            <h3>7.1 AIã‚’åˆ©ç”¨ã—ãŸæ”»æ’ƒã¸ã®å¯¾å‡¦</h3>
            <div class="step-container">
                <div class="step">
                    <strong>AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ”»æ’ƒå¯¾ç­–</strong>
                    <div class="command">
                        <div># ãƒœãƒƒãƒˆæ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ </div>
                        <div>pip install django-recaptcha</div>
                        
                        <div># settings.py reCAPTCHAè¨­å®š</div>
                        <div>RECAPTCHA_PUBLIC_KEY = os.environ.get('RECAPTCHA_PUBLIC_KEY')</div>
                        <div>RECAPTCHA_PRIVATE_KEY = os.environ.get('RECAPTCHA_PRIVATE_KEY')</div>
                        <div>RECAPTCHA_USE_SSL = True</div>
                        
                        <div># ãƒ•ã‚©ãƒ¼ãƒ ã§ã®ä½¿ç”¨</div>
                        <div>from captcha.fields import ReCaptchaField</div>
                        <div>captcha = ReCaptchaField()</div>
                        
                        <div># ç•°å¸¸ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œçŸ¥</div>
                        <div>SUSPICIOUS_REQUEST_PATTERNS = [</div>
                        <div>    r'(?i).*<script.*>.*</script>.*',  # XSS</div>
                        <div>    r'(?i).*(union|select|insert|delete|drop).*',  # SQLi</div>
                        <div>    r'.*\.\./.*',  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«</div>
                        <div>]</div>
                    </div>
                </div>

                <div class="step">
                    <strong>æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«æ”»æ’ƒå¯¾ç­–</strong>
                    <div class="command">
                        <div># å…¥åŠ›ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†å¼·åŒ–</div>
                        <div>import bleach</div>
                        <div>from django.utils.html import escape</div>
                        <div></div>
                        <div>def sanitize_ml_input(data):</div>
                        <div>    # HTMLã‚¿ã‚°é™¤å»</div>
                        <div>    clean_data = bleach.clean(data, strip=True)</div>
                        <div>    # ç‰¹æ®Šæ–‡å­—ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—</div>
                        <div>    clean_data = escape(clean_data)</div>
                        <div>    # é•·ã•åˆ¶é™</div>
                        <div>    return clean_data[:1000]</div>
                        
                        <div># ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ </div>
                        <div>def detect_anomalous_input(request_data):</div>
                        <div>    # ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼è¨ˆç®—ã§ç•°å¸¸æ¤œçŸ¥</div>
                        <div>    import math</div>
                        <div>    from collections import Counter</div>
                        <div>    </div>
                        <div>    char_counts = Counter(request_data)</div>
                        <div>    entropy = -sum(count/len(request_data) * math.log2(count/len(request_data)) </div>
                        <div>                   for count in char_counts.values())</div>
                        <div>    return entropy > 4.5  # é«˜ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ = ç•°å¸¸</div>
                    </div>
                </div>
            </div>

            <h3>7.2 ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒç‰¹æœ‰ã®è„…å¨å¯¾ç­–</h3>
            <div class="step-container">
                <div class="step">
                    <strong>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹æ”»æ’ƒé˜²æ­¢</strong>
                    <div class="command">
                        <div># SSRFæ”»æ’ƒé˜²æ­¢</div>
                        <div>import requests</div>
                        <div>from urllib.parse import urlparse</div>
                        <div></div>
                        <div>BLOCKED_NETWORKS = [</div>
                        <div>    '169.254.169.254',  # AWS/GCP ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</div>
                        <div>    '127.0.0.1',        # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆ</div>
                        <div>    '10.0.0.0/8',       # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</div>
                        <div>    '172.16.0.0/12',    # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</div>
                        <div>    '192.168.0.0/16',   # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</div>
                        <div>]</div>
                        <div></div>
                        <div>def is_safe_url(url):</div>
                        <div>    parsed = urlparse(url)</div>
                        <div>    if parsed.hostname in BLOCKED_NETWORKS:</div>
                        <div>        return False</div>
                        <div>    return True</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹æ”»æ’ƒå¯¾ç­–</strong>
                    <div class="command">
                        <div># å®Ÿè¡Œæ™‚é–“åˆ¶é™</div>
                        <div>import signal</div>
                        <div></div>
                        <div>def timeout_handler(signum, frame):</div>
                        <div>    raise TimeoutError('å‡¦ç†æ™‚é–“è¶…é')</div>
                        <div></div>
                        <div>def safe_execute(func, timeout=30):</div>
                        <div>    signal.signal(signal.SIGALRM, timeout_handler)</div>
                        <div>    signal.alarm(timeout)</div>
                        <div>    try:</div>
                        <div>        return func()</div>
                        <div>    finally:</div>
                        <div>        signal.alarm(0)</div>
                        
                        <div># ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡åˆ¶é™</div>
                        <div>import resource</div>
                        <div></div>
                        <div>def limit_memory(max_memory_mb=100):</div>
                        <div>    resource.setrlimit(resource.RLIMIT_AS, </div>
                        <div>                      (max_memory_mb * 1024 * 1024, -1))</div>
                    </div>
                </div>
            </div>

            <h3>7.3 IoTãƒ»ãƒ¢ãƒã‚¤ãƒ«é€£æºã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
            <div class="step-container">
                <div class="step">
                    <strong>ãƒ‡ãƒã‚¤ã‚¹èªè¨¼å¼·åŒ–</strong>
                    <div class="command">
                        <div># ãƒ‡ãƒã‚¤ã‚¹å›ºæœ‰IDæ¤œè¨¼</div>
                        <div>import hashlib</div>
                        <div>import hmac</div>
                        <div></div>
                        <div>def generate_device_token(device_id, secret_key):</div>
                        <div>    return hmac.new(</div>
                        <div>        secret_key.encode(),</div>
                        <div>        device_id.encode(),</div>
                        <div>        hashlib.sha256</div>
                        <div>    ).hexdigest()</div>
                        
                        <div>def validate_device_token(device_id, token, secret_key):</div>
                        <div>    expected_token = generate_device_token(device_id, secret_key)</div>
                        <div>    return hmac.compare_digest(token, expected_token)</div>
                        
                        <div># ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²åˆ¶é™</div>
                        <div>MAX_DEVICES_PER_USER = 5</div>
                        <div>DEVICE_TOKEN_EXPIRY = 86400  # 24æ™‚é–“</div>
                    </div>
                </div>

                <div class="step">
                    <strong>API ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¨ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°</strong>
                    <div class="command">
                        <div># å‹•çš„ãƒ¬ãƒ¼ãƒˆåˆ¶é™</div>
                        <div>from functools import wraps</div>
                        <div>from django.core.cache import cache</div>
                        <div></div>
                        <div>def dynamic_ratelimit(key_func, rate_func):</div>
                        <div>    def decorator(func):</div>
                        <div>        @wraps(func)</div>
                        <div>        def wrapper(request, *args, **kwargs):</div>
                        <div>            key = key_func(request)</div>
                        <div>            rate_limit = rate_func(request)</div>
                        <div>            </div>
                        <div>            current = cache.get(key, 0)</div>
                        <div>            if current >= rate_limit:</div>
                        <div>                return JsonResponse({'error': 'Rate limit exceeded'}, </div>
                        <div>                                  status=429)</div>
                        <div>            </div>
                        <div>            cache.set(key, current + 1, 3600)  # 1æ™‚é–“</div>
                        <div>            return func(request, *args, **kwargs)</div>
                        <div>        return wrapper</div>
                        <div>    return decorator</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="advanced-security">
            <h2>ğŸ›¡ï¸ 8. é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</h2>

            <h3>8.1 Web Application Firewall (WAF)</h3>
            <div class="command">
                <div># ModSecurity ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                <div>sudo apt install libapache2-mod-security2 -y</div>
                
                <div># OWASP Core Rule Set</div>
                <div>cd /etc/modsecurity</div>
                <div>sudo wget https://github.com/coreruleset/coreruleset/archive/v3.3.4.tar.gz</div>
                <div>sudo tar -xzf v3.3.4.tar.gz</div>
                
                <div># ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«è¨­å®š</div>
                <div>sudo cp crs-setup.conf.example crs-setup.conf</div>
            </div>

            <h3>8.2 ä¾µå…¥æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ  (IDS)</h3>
            <div class="step-container">
                <div class="step">
                    <strong>OSSEC ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</strong>
                    <div class="command">
                        <div># OSSEC ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                        <div>wget https://github.com/ossec/ossec-hids/archive/3.6.0.tar.gz</div>
                        <div>tar -xzf 3.6.0.tar.gz</div>
                        <div>cd ossec-hids-3.6.0</div>
                        <div>sudo ./install.sh</div>
                    </div>
                </div>

                <div class="step">
                    <strong>ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ç›£è¦–</strong>
                    <div class="command">
                        <div># AIDE ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                        <div>sudo apt install aide -y</div>
                        
                        <div># ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–</div>
                        <div>sudo aideinit</div>
                        
                        <div># æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</div>
                        <div>sudo aide --check</div>
                    </div>
                </div>
            </div>

            <h3>8.3 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–</h3>
            <div class="command">
                <div># Suricata IDS ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
                <div>sudo apt install suricata -y</div>
                
                <div># ãƒ«ãƒ¼ãƒ«æ›´æ–°</div>
                <div>sudo suricata-update</div>
                
                <div># ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹</div>
                <div>sudo systemctl enable suricata</div>
                <div>sudo systemctl start suricata</div>
                
                <div># ã‚¢ãƒ©ãƒ¼ãƒˆç¢ºèª</div>
                <div>sudo tail -f /var/log/suricata/fast.log</div>
            </div>

            <h3>8.4 è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³è‡ªå‹•åŒ–</h3>
            <div class="command">
                <div># Nmap ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³</div>
                <div>nmap -sS -O -sV --script vuln localhost</div>
                
                <div># Nikto Webã‚¹ã‚­ãƒ£ãƒŠãƒ¼</div>
                <div>sudo apt install nikto -y</div>
                <div>nikto -h https://maruomosquit.com</div>
                
                <div># OpenVAS è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒŠãƒ¼</div>
                <div>docker run -d -p 443:443 --name openvas mikesplain/openvas</div>
            </div>

            <div class="danger">
                <strong>è­¦å‘Š:</strong> è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ãƒ„ãƒ¼ãƒ«ã¯è‡ªåˆ†ã®ã‚·ã‚¹ãƒ†ãƒ ã«å¯¾ã—ã¦ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                ä»–è€…ã®ã‚·ã‚¹ãƒ†ãƒ ã«å¯¾ã™ã‚‹ç„¡è¨±å¯ã®ã‚¹ã‚­ãƒ£ãƒ³ã¯é•æ³•è¡Œç‚ºã¨ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
            </div>
        </section>

        <h2>ğŸ“‹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
        <div class="check">
            <h3>æ¯æ—¥ã®ç¢ºèªé …ç›®</h3>
            <ul>
                <li>â–¡ <code>netstat -tn</code> ã§ä¸å¯©ãªæ¥ç¶šãŒãªã„ã‹ç¢ºèª</li>
                <li>â–¡ <code>sudo tail -20 /var/log/auth.log</code> ã§SSHæ”»æ’ƒç¢ºèª</li>
                <li>â–¡ <code>sudo systemctl status nginx</code> ã§Webã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç¢ºèª</li>
                <li>â–¡ <code>sudo systemctl status gunicorn</code> ã§Djangoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ³ç¢ºèª</li>
                <li>â–¡ <code>ps aux | head -20</code> ã§ä¸å¯©ãªãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª</li>
            </ul>

            <h3>é€±æ¬¡ã®ç¢ºèªé …ç›®</h3>
            <ul>
                <li>â–¡ <code>sudo iptables -L</code> ã§ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šç¢ºèª</li>
                <li>â–¡ <code>sudo fail2ban-client status</code> ã§æ”»æ’ƒãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ³ç¢ºèª</li>
                <li>â–¡ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ç¢ºèª</li>
                <li>â–¡ SSLè¨¼æ˜æ›¸ã®æœ‰åŠ¹æœŸé™ç¢ºèª</li>
                <li>â–¡ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ç¢ºèªã¨é©ç”¨</li>
            </ul>

            <h3>æœˆæ¬¡ã®ç¢ºèªé …ç›®</h3>
            <ul>
                <li>â–¡ SSHéµã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¤œè¨</li>
                <li>â–¡ nginxè¨­å®šã®è¦‹ç›´ã—</li>
                <li>â–¡ Djangoä¾å­˜é–¢ä¿‚ã®æ›´æ–°ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨</li>
                <li>â–¡ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šã®ç¢ºèª</li>
                <li>â–¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®è¦‹ç›´ã—</li>
            </ul>
        </div>

        <div class="success">
            <h3>ğŸ¯ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®åŠ¹æœ</h3>
            <ul>
                <li><strong>SSHæ”»æ’ƒã®å®Œå…¨é®æ–­:</strong> ä¸æ­£ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã‚’é˜²æ­¢</li>
                <li><strong>Webæ”»æ’ƒã®é˜²å¾¡:</strong> ãƒ—ãƒ­ã‚­ã‚·æ‚ªç”¨ã‚„DDoSæ”»æ’ƒã‚’é˜²æ­¢</li>
                <li><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿è­·:</strong> ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’é®æ–­ã—ã¦ãƒ‡ãƒ¼ã‚¿æ¼æ´©é˜²æ­¢</li>
                <li><strong>APTæ”»æ’ƒå¯¾ç­–:</strong> é•·æœŸæ½œä¼å‹æ”»æ’ƒã®æ¤œçŸ¥ã¨é˜²å¾¡</li>
                <li><strong>ç¶™ç¶šç›£è¦–:</strong> ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®è„…å¨æ¤œçŸ¥</li>
            </ul>
        </div>

        <div class="alert">
            <strong>é‡è¦ãªæ³¨æ„äº‹é …:</strong>
            <ul>
                <li>è¨­å®šå¤‰æ›´å‰ã«ã¯å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—ã—ã¦ãã ã•ã„</li>
                <li>æœ¬ç•ªç’°å¢ƒã§ã®ä½œæ¥­ã¯ååˆ†ãªæ¤œè¨¼å¾Œã«å®Ÿæ–½ã—ã¦ãã ã•ã„</li>
                <li>ç·Šæ€¥æ™‚ã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã‚’äº‹å‰ã«æº–å‚™ã—ã¦ãã ã•ã„</li>
                <li>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã¯å®šæœŸçš„ã«è¦‹ç›´ã—ã¦ãã ã•ã„</li>
                <li>ã“ã®ã‚¬ã‚¤ãƒ‰ã¯é˜²å¾¡çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å­¦ç¿’ç›®çš„ã§ä½œæˆã•ã‚Œã¦ã„ã¾ã™</li>
            </ul>
        </div>

        <hr>

        <p style="text-align: center; color: #666; margin-top: 30px;">
            <strong>ä½œæˆæ—¥:</strong> 2024å¹´8æœˆ12æ—¥<br>
            <strong>å¯¾è±¡:</strong> Ubuntu Server + nginx + Djangoç’°å¢ƒ<br>
            <strong>ç›®çš„:</strong> åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é˜²å¾¡ã®å®Ÿè£…<br>
            <strong>æ›´æ–°:</strong> ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã«å¿œã˜ã¦éšæ™‚æ›´æ–°
        </p>
    </div>
</body>
</html>
